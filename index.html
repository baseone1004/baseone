<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BaseOne (Simple)</title>
  <style>
    :root{
      --bg:#0f1630;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --text:#f8faff;
      --muted:rgba(248,250,255,.75);
      --border:rgba(255,255,255,.14);
      --primary:#7aa7ff;
      --good:#38e1c1;
      --danger:#ff7b7b;
      --shadow:0 10px 24px rgba(0,0,0,.22);
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:#ffffff;
      --panel2:#f0f3ff;
      --text:#0f1630;
      --muted:rgba(15,22,48,.7);
      --border:rgba(15,22,48,.12);
      --primary:#2f6bff;
      --good:#00b894;
      --danger:#e74c3c;
      --shadow:0 10px 22px rgba(15,22,48,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(122,167,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 20%, rgba(56,225,193,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), #0a1022);
      color:var(--text);
      font-size:13px;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .top{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      padding:8px 4px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--primary), var(--good));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;box-shadow:var(--shadow);
    }
    .title{font-size:18px;font-weight:900;line-height:1}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);font-size:12px;
    }

    .box{
      background:var(--panel);
      border:1px solid var(--border);
      padding:12px;
      border-radius:16px;
      margin:10px 0;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    [data-theme="light"] .box{backdrop-filter:none}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}

    input, select, textarea{
      padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);outline:none;
      font-size:12.5px;
    }
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{
      background:rgba(15,22,48,.04);
    }
    select{min-width:280px}
    textarea{width:100%;min-height:160px;line-height:1.6}

    .btn{
      padding:8px 11px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);cursor:pointer;font-weight:900;font-size:12px;
      transition:transform .05s ease, filter .15s ease;
    }
    [data-theme="light"] .btn{background:rgba(15,22,48,.04)}
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--primary), #2f6bff);border:none;color:#fff}
    .btn.good{background:linear-gradient(135deg,var(--good), #1fb6ff);border:none;color:#fff}
    .btn.danger{background:rgba(255,107,107,.10);border:1px solid rgba(255,107,107,.35);color:var(--danger)}

    .small{font-size:12px;color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    .cat{
      background:var(--panel2);
      border:1px solid var(--border);
      padding:10px;
      border-radius:14px;
      cursor:pointer;
      transition:transform .08s ease, filter .15s ease, border-color .15s ease;
    }
    .cat:hover{transform:translateY(-1px);filter:brightness(1.05);border-color:rgba(122,167,255,.55)}
    .cat b{font-size:13px}
    .cat .desc{font-size:11.5px;color:var(--muted);margin-top:4px}

    .list{max-height:320px;overflow:auto;margin-top:10px;padding-right:6px}
    .item{
      background:var(--panel2);
      border:1px solid var(--border);
      padding:10px;
      border-radius:14px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      margin-bottom:8px;
      cursor:pointer;
    }
    .item.active{
      border-color:rgba(122,167,255,.85);
      box-shadow:0 0 0 2px rgba(122,167,255,.18);
      background:linear-gradient(135deg, rgba(122,167,255,.12), rgba(56,225,193,.10));
    }
    .itemTitle{font-weight:900}
    .itemMeta{font-size:11.5px;color:var(--muted);margin-top:4px}

    .progWrap{
      margin-top:10px;border:1px solid var(--border);
      border-radius:999px;overflow:hidden;height:12px;background:rgba(255,255,255,.08);
    }
    [data-theme="light"] .progWrap{background:rgba(15,22,48,.05)}
    .progBar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--good));transition:width .2s ease}

    /* preview */
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:900px){.two{grid-template-columns:1fr}}
    .card{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .pre{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      min-height:180px;
      white-space:pre-wrap;
      overflow:auto;
      background:rgba(0,0,0,.10);
    }
    [data-theme="light"] .pre{background:rgba(15,22,48,.03)}
    .iframeWrap{
      margin-top:8px;
      background:#fff;border-radius:12px;overflow:hidden;
      border:1px solid var(--border);min-height:320px;
    }
    iframe{width:100%;height:320px;border:0}

    /* log */
    #logBox{display:none}
    #log{
      margin-top:10px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      max-height:220px;
      overflow:auto;
      font-size:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BaseOne</div>
        <div class="subtitle">ì£¼ì œ ì„ íƒ â†’ AI ìƒì„± â†’ ë¯¸ë¦¬ë³´ê¸° â†’ ì¦‰ì‹œë°œí–‰</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill">ğŸ›°ï¸ ì„œë²„ <b id="sv">-</b></span>
      <button class="btn" onclick="toggleTheme()">ğŸŒ“</button>
      <a href="/settings"><button class="btn">âš™ï¸ ì„¤ì •</button></a>
    </div>
  </div>

  <!-- ë¸”ë¡œê·¸ ì„ íƒ -->
  <div class="box">
    <div class="row">
      <div>
        <b>1) ë¸”ë¡œê·¸ ì„ íƒ</b>
        <div class="small">ì €ì¥ëœ ë¸”ë¡œê·¸ ì£¼ì†Œê°€ ëœ¹ë‹ˆë‹¤.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="blogSelect"></select>
        <button class="btn" onclick="loadBlogsToSelect()">ğŸ”„</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">âœ… í˜„ì¬ ì„ íƒ: <b id="blogNow">-</b></div>
  </div>

  <!-- ì£¼ì œ ìƒì„± -->
  <div class="box">
    <div class="row">
      <div>
        <b>2) ì£¼ì œ ì„ íƒ</b>
        <div class="small">ì¹´í…Œê³ ë¦¬ë¥¼ ëˆ„ë¥´ë©´ ì£¼ì œê°€ ìƒì„±ë©ë‹ˆë‹¤.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="filter" placeholder="ğŸ” ê²€ìƒ‰" oninput="renderTopics()">
        <button class="btn" onclick="copyAll()">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
        <button class="btn primary" onclick="aiGenerate()">âœ¨ AI ìƒì„±</button>
      </div>
    </div>

    <div class="grid" id="catGrid"></div>

    <div class="progWrap">
      <div class="progBar" id="progBar"></div>
    </div>
    <div class="small" id="progText" style="margin-top:6px">ì§„í–‰ë¥ : 0%</div>

    <div class="list" id="topicList"></div>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° + ë°œí–‰ -->
  <div class="box" id="previewBox" style="display:none">
    <div class="row">
      <div>
        <b>3) ë¯¸ë¦¬ë³´ê¸° / ë°œí–‰</b>
        <div class="small" id="previewMeta">-</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="openPreviewWindow()">ğŸ§¾ ìƒˆì°½</button>
        <button class="btn good" onclick="publishNow()">ğŸš€ ì¦‰ì‹œë°œí–‰</button>
        <button class="btn" onclick="toggleLog()">ğŸ§¾ ë¡œê·¸</button>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <div style="font-weight:900">ğŸ“ ë³¸ë¬¸(ì›ë¬¸)</div>
        <div class="pre" id="finalBody"></div>
      </div>
      <div class="card">
        <div style="font-weight:900">ğŸ–¼ï¸ ì´ë¯¸ì§€(URL/í”„ë¡¬í”„íŠ¸)</div>
        <div class="pre" id="finalImage"></div>
        <div style="margin-top:10px">
          <img id="previewImg" alt="preview" style="width:100%;border-radius:12px;border:1px solid var(--border);display:none"/>
          <div class="small" id="imgHint" style="margin-top:8px">ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ì•„ë˜ì— ë³´ì…ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:900">ğŸ‘€ HTML ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="iframeWrap">
        <iframe id="previewIframe"></iframe>
      </div>
    </div>

    <div class="box" id="logBox">
      <div class="row">
        <b>ğŸ§¾ ë¡œê·¸</b>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="toggleLog()">ğŸ‘€ í† ê¸€</button>
          <button class="btn danger" onclick="clearLog()">ğŸ§¹ ì§€ìš°ê¸°</button>
        </div>
      </div>
      <div id="log"></div>
    </div>
  </div>
</div>

<script>
/* ---------------- Theme ---------------- */
const THEME_KEY="baseone_theme_simple_v1";
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "dark";
  document.documentElement.setAttribute("data-theme", saved);
})();
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  const next = (cur === "dark") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem(THEME_KEY, next);
}

/* ---------------- API Base ---------------- */
function getApiBase(){
  const d = JSON.parse(localStorage.getItem("baseone_settings_v3") || "{}");
  const base = (d.backend || "http://127.0.0.1:5000").trim();
  return base.replace(/\/+$/,"");
}
const API_BASE = getApiBase();
document.addEventListener("DOMContentLoaded", ()=> {
  const el = document.getElementById("sv");
  if(el) el.textContent = API_BASE;
});

/* ---------------- Utils ---------------- */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function copyAll(){
  if(!topics.length){ alert("ì£¼ì œ ì—†ìŒ"); return; }
  navigator.clipboard.writeText(topics.map(x=>x.title).join("\n"));
  alert("ì „ì²´ ë³µì‚¬ ì™„ë£Œ!");
}
function setProgress(pct){
  const v = Math.max(0, Math.min(100, Math.round(Number(pct)||0)));
  document.getElementById("progBar").style.width = v + "%";
  document.getElementById("progText").textContent = `ì§„í–‰ë¥ : ${v}%`;
}

/* ---------------- Log (ONE) ---------------- */
function toggleLog(){
  const box=document.getElementById("logBox");
  box.style.display = (box.style.display==="none" ? "block" : "none");
}
function clearLog(){ document.getElementById("log").innerHTML=""; setProgress(0); }
function logLine(icon, color, msg){
  const log=document.getElementById("log");
  const t=new Date();
  const time = String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")+":"+String(t.getSeconds()).padStart(2,"0");
  log.innerHTML += `<div style="color:${color}">${icon} <b>[${time}]</b> ${escapeHtml(msg)}</div>`;
  log.scrollTop = log.scrollHeight;
}
function logInfo(m){ logLine("ğŸŸ¦","var(--text)",m); }
function logOk(m){ logLine("âœ…","var(--good)",m); }
function logErr(m){ logLine("âŒ","var(--danger)",m); }

/* ---------------- Blog Select ---------------- */
function loadBlogsToSelect(){
  const sel=document.getElementById("blogSelect");
  const now=document.getElementById("blogNow");
  sel.innerHTML="";

  let v2=null;
  try{ v2 = JSON.parse(localStorage.getItem("baseone_settings_v2")||"null"); }catch(e){}
  const v3 = JSON.parse(localStorage.getItem("baseone_settings_v3")||"{}");

  const blogs = (v2 && v2.blogs) ? v2.blogs : {
    blogspot: (v3.blogspot||[]),
    naver: (v3.naver||[]),
    tistory: (v3.tistory||[])
  };

  const options=[];
  (blogs.blogspot||[]).filter(Boolean).forEach((u,i)=>options.push({type:"blogspot",url:u,label:`ğŸŸ¦ ë¸”ë¡œê·¸ìŠ¤íŒŸ ${i+1} - ${u}`}));
  (blogs.naver||[]).filter(Boolean).forEach((u,i)=>options.push({type:"naver",url:u,label:`ğŸŸ© ë„¤ì´ë²„ ${i+1} - ${u}`}));
  (blogs.tistory||[]).filter(Boolean).forEach((u,i)=>options.push({type:"tistory",url:u,label:`ğŸŸ§ í‹°ìŠ¤í† ë¦¬ ${i+1} - ${u}`}));

  if(!options.length){
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="ì €ì¥ëœ ë¸”ë¡œê·¸ ì£¼ì†Œ ì—†ìŒ â†’ ì„¤ì •(/settings)ì—ì„œ ì €ì¥";
    sel.appendChild(opt);
    now.textContent="-";
    return;
  }

  options.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=JSON.stringify({type:o.type,url:o.url}); // (í•„ìš”í•˜ë©´ blog_id/nameë„ ì—¬ê¸°ì— ì €ì¥)
    opt.textContent=o.label;
    sel.appendChild(opt);
  });

  const last=localStorage.getItem("baseone_last_blog");
  if(last){
    for(let i=0;i<sel.options.length;i++){
      if(sel.options[i].value===last){sel.selectedIndex=i;break;}
    }
  }
  updateBlogNow();
}
function updateBlogNow(){
  const sel=document.getElementById("blogSelect");
  const now=document.getElementById("blogNow");
  const v=sel.value;
  if(!v){ now.textContent="-"; return; }
  localStorage.setItem("baseone_last_blog", v);
  try{
    const obj=JSON.parse(v);
    now.textContent=`${obj.type} / ${obj.url}`;
  }catch(e){ now.textContent="-"; }
}
function getSelectedBlog(){
  const v=document.getElementById("blogSelect").value;
  if(!v) return null;
  try{ return JSON.parse(v); }catch(e){ return null; }
}
document.addEventListener("change",(e)=>{
  if(e.target && e.target.id==="blogSelect") updateBlogNow();
});

/* ---------------- Categories + Topics ---------------- */
const CATS=[
  {k:"ëˆ/ì¬í…Œí¬", s:"ğŸ’° ì ˆì•½Â·ì„¸ê¸ˆ"},
  {k:"ìƒí™œ/ê°€ì „", s:"ğŸ  ì‚´ë¦¼Â·ì ˆì•½"},
  {k:"ì»´í“¨í„°/IT", s:"ğŸ’» ìœ í‹¸Â·ë³´ì•ˆ"},
  {k:"ì—¬í–‰", s:"ğŸ§³ ì½”ìŠ¤Â·ê¿€íŒ"},
  {k:"ê±´ê°•", s:"ğŸƒ ìš´ë™Â·ì˜ì–‘"},
  {k:"ìš”ë¦¬", s:"ğŸ³ ë ˆì‹œí”¼"},
  {k:"ìê¸°ê³„ë°œ", s:"ğŸ“ˆ ìŠµê´€"},
  {k:"ê³µë¶€/ìê²©ì¦", s:"ğŸ“š í•©ê²©"},
];
const catGrid=document.getElementById("catGrid");
CATS.forEach(obj=>{
  const d=document.createElement("div");
  d.className="cat";
  d.onclick=()=>makeTopics(obj.k);
  d.innerHTML = `<b>${obj.k}</b><div class="desc">${obj.s}</div>`;
  catGrid.appendChild(d);
});

let topics=[];           // [{id,title}]
let selectedCat="";
let selectedTopicId="";

function buildIdeas(cat, n=24){
  const hooks=["ì´ˆë³´ë„ ë°”ë¡œ ë˜ëŠ”","ì‹¤íŒ¨ ì—†ëŠ”","í•˜ë£¨ 10ë¶„","ëˆ ìƒˆëŠ” êµ¬ë© ë§‰ëŠ”","ì˜¤ëŠ˜ë¶€í„° ì ìš© ê°€ëŠ¥í•œ","ì •ë¦¬ í•œ ë²ˆì— ëë‚´ëŠ”"];
  const basesByCat={
    "ëˆ/ì¬í…Œí¬":["ì›” {x}ë§Œì› ì•„ë¼ëŠ” ê³ ì •ë¹„ ì ê²€í‘œ","ì¹´ë“œ í˜œíƒ 200% ì“°ëŠ” ë²•","í†µì‹ ë¹„ ì¤„ì´ëŠ” ìˆœì„œ","ë¹„ìƒê¸ˆ í†µì¥ ë§Œë“œëŠ” ë²•","ì—°ë§ì •ì‚° ë†“ì¹˜ê¸° ì‰¬ìš´ í•­ëª©"],
    "ìƒí™œ/ê°€ì „":["ì „ê¸°ìš”ê¸ˆ ì¤„ì´ëŠ” ìŠµê´€","ê°€ì „ ìˆ˜ëª… ëŠ˜ë¦¬ëŠ” ê´€ë¦¬ë²•","ì²­ì†Œ ì‹œê°„ ë°˜ìœ¼ë¡œ ì¤„ì´ëŠ” íŒ","ì •ë¦¬ì •ëˆ ë£¨í‹´","ìƒí™œë¹„ ì ˆì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸"],
    "ì»´í“¨í„°/IT":["PC ëŠë¦´ ë•Œ í•´ê²° ìˆœì„œ","ìœˆë„ìš° í•„ìˆ˜ ì„¤ì •","ë³´ì•ˆ(í”¼ì‹±) ì˜ˆë°© ì²´í¬","í¬ë¡¬ ìµœì í™”","ìš©ëŸ‰ ì¤„ì´ëŠ” ë°©ë²•"],
    "ì—¬í–‰":["ì£¼ë§ 1ë°•2ì¼ ì½”ìŠ¤","ê²½ë¹„ ì¤„ì´ëŠ” ê¿€íŒ","ìˆ™ì†Œ ê³ ë¥´ëŠ” ë²•","ë¹„ ì˜¤ëŠ” ë‚  ì¼ì •","ì‚¬ì§„ ìŠ¤íŒŸ ì¶”ì²œ"],
    "ê±´ê°•":["ë©´ì—­ë ¥ ë£¨í‹´","ì  ì˜ ì˜¤ëŠ” í™˜ê²½","í”¼ê³¤í•  ë•Œ ì²´í¬","ìš´ë™ ì´ˆë³´ ë£¨í‹´","ì‹ë‹¨ ê¸°ë³¸"],
    "ìš”ë¦¬":["ì‹¤íŒ¨ ì—†ëŠ” ë ˆì‹œí”¼","ì¬ë£Œ 3ê°œ ìš”ë¦¬","10ë¶„ ì™„ì„±","ëƒ‰ì¥ê³  í„¸ì´","ê°„ë‹¨ ë„ì‹œë½"],
    "ìê¸°ê³„ë°œ":["ìŠµê´€ ë§Œë“œëŠ” ë²•","ì‹œê°„ê´€ë¦¬ ë£¨í‹´","ë¯¸ë£¨ëŠ” ìŠµê´€ ëŠê¸°","ëª©í‘œ ì„¤ì •ë²•","í•˜ë£¨ ë£¨í‹´"],
    "ê³µë¶€/ìê²©ì¦":["í•©ê²© ê³µë¶€ ë£¨í‹´","ì•”ê¸° íŒ","ì˜¤ë‹µë…¸íŠ¸ ë°©ë²•","ì‹œí—˜ ì§ì „ ì²´í¬","ê³„íš ì„¸ìš°ê¸°"],
  };
  const bases = basesByCat[cat] || ["{cat} ê¸°ë³¸ ê°€ì´ë“œ","{cat} ì‹¤ìˆ˜ TOP {x}","{cat} ì²´í¬ë¦¬ìŠ¤íŠ¸"];
  const out=new Set();
  let tries=0;
  while(out.size<n && tries<400){
    tries++;
    const h = hooks[Math.floor(Math.random()*hooks.length)];
    const b = bases[Math.floor(Math.random()*bases.length)];
    const x = 5 + Math.floor(Math.random()*6);
    out.add((h+" "+b).replaceAll("{x}", String(x)).replaceAll("{cat}", cat).trim());
  }
  return Array.from(out);
}
function makeTopics(cat){
  selectedCat=cat;
  const titles=buildIdeas(cat, 24);
  topics = titles.map((t,i)=>({id:`${Date.now()}_${i}`, title:t}));
  selectedTopicId = topics[0]?.id || "";
  renderTopics();
}
function getSelectedTitle(){
  return topics.find(x=>x.id===selectedTopicId)?.title || "";
}
function renderTopics(){
  const q=(document.getElementById("filter").value||"").trim().toLowerCase();
  const box=document.getElementById("topicList");
  box.innerHTML="";
  let arr=topics.slice();
  if(q) arr=arr.filter(x=>x.title.toLowerCase().includes(q));
  if(!arr.length){
    box.innerHTML=`<div class="small">ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;
    return;
  }
  arr.forEach(it=>{
    const d=document.createElement("div");
    d.className="item"+(it.id===selectedTopicId?" active":"");
    d.onclick=()=>{ selectedTopicId=it.id; renderTopics(); };
    d.innerHTML=`
      <div style="flex:1">
        <div class="itemTitle">${escapeHtml(it.title)}</div>
        <div class="itemMeta">ğŸ·ï¸ ${escapeHtml(selectedCat || "-")}</div>
      </div>
      <button class="btn" onclick="event.stopPropagation(); navigator.clipboard.writeText('${it.title.replaceAll("'","\\'")}'); alert('ë³µì‚¬ ì™„ë£Œ!');">ë³µì‚¬</button>
    `;
    box.appendChild(d);
  });
}

/* ---------------- AI Generate ---------------- */
function applyTemplate(bodyPrompt){
  // "ì‚¬ëŒë“¤ì´ ë³´ê¸° í¸í•˜ê²Œ" ìµœì†Œë§Œ: ì„œë²„ê°€ body_prompt/htmlì„ ì£¼ë©´ ê·¸ëŒ€ë¡œ ì“°ê³ , ì—†ìœ¼ë©´ body_promptë¥¼ í‘œì‹œ
  return bodyPrompt || "";
}

async function aiGenerate(){
  const blog=getSelectedBlog();
  const title=getSelectedTitle();
  if(!blog){ alert("ë¸”ë¡œê·¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
  if(!title){ alert("ì£¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }

  document.getElementById("previewBox").style.display="none";
  setProgress(5);
  logInfo(`ğŸ›°ï¸ ì„œë²„: ${API_BASE}`);
  logInfo(`ğŸ§  ì£¼ì œ: ${title}`);
  logInfo(`ğŸ·ï¸ ì¹´í…Œê³ ë¦¬: ${selectedCat || "-"}`);

  const sV3 = JSON.parse(localStorage.getItem("baseone_settings_v3")||"{}");
  const v2  = JSON.parse(localStorage.getItem("baseone_settings_v2")||"{}");
  const payload={
    topic:title,
    category:selectedCat,
    blog:blog.type || "blogspot",
    img_provider:(v2.imgProvider || sV3.img_provider || "pexels"),
    pexels_key:(v2.pexelsKey || sV3.pexels_key || "")
  };

  try{
    setProgress(15);
    const res=await fetch(API_BASE+"/api/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(!res.ok){
      const t=await res.text();
      setProgress(0);
      logErr("ìƒì„± ì‹¤íŒ¨: "+t);
      alert("ìƒì„± ì‹¤íŒ¨: "+t);
      return;
    }
    const data=await res.json();
    setProgress(80);
    logOk("ìƒì„± ì™„ë£Œ");

    // ì„œë²„ ì‘ë‹µ í˜¸í™˜: body_prompt/html ë‘˜ ë‹¤ ëŒ€ì‘
    const body = applyTemplate(data.html || data.body_prompt || "");
    const imageText = (data.image_url ? data.image_url : (data.image_prompt||""));

    // í™”ë©´
    document.getElementById("finalBody").textContent = body;
    document.getElementById("finalImage").textContent = (data.image_prompt ? (data.image_prompt+"\n"+(data.image_url||"")) : (data.image_url||""));
    document.getElementById("previewMeta").textContent =
      `ğŸ§  ${data.topic||title} / ğŸ·ï¸ ${data.category||selectedCat||"-"} / ğŸ—‚ï¸ ${blog.type} / â±ï¸ ${data.generated_at||""}`;

    // iframe ë¯¸ë¦¬ë³´ê¸°
    const iframe=document.getElementById("previewIframe");
    const doc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style>
      </head><body>${body}</body></html>`;
    iframe.srcdoc = doc;

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    const urlMatch = ((data.image_url||"").match(/https?:\/\/[^\s]+/g) || [])[0] || "";
    const img=document.getElementById("previewImg");
    const hint=document.getElementById("imgHint");
    if(urlMatch){
      img.src=urlMatch;
      img.style.display="block";
      hint.style.display="none";
    }else{
      img.style.display="none";
      hint.style.display="block";
    }

    document.getElementById("previewBox").style.display="block";
    setProgress(100);

  }catch(e){
    setProgress(0);
    logErr("ì„œë²„ ì—°ê²° ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/CORS/API_BASE í™•ì¸)");
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨! ì„¤ì •ì˜ ì„œë²„ ì£¼ì†Œ(API_BASE)ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
  }
}

/* ---------------- Preview Window ---------------- */
function openPreviewWindow(){
  const body = document.getElementById("finalBody")?.textContent?.trim() || "";
  if(!body){ alert("ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ìƒì„±í•˜ì„¸ìš”."); return; }
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ë¯¸ë¦¬ë³´ê¸°</title>
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style>
  </head><body>${body}</body></html>`);
  w.document.close();
}

/* ---------------- Publish (Now) ----------------
   âš ï¸ ì¤‘ìš”:
   - "ì§„ì§œ ì¦‰ì‹œë°œí–‰"ì€ ì„œë²„ê°€ Blogger OAuth ì™„ë£Œ + ì‹¤ì œ ê¸€ ì—…ë¡œë“œ ë¡œì§ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
   - ì§€ê¸ˆì€ /api/publish/now ê°€ ë¬´ì—‡ì„ í•˜ëŠ”ì§€(ì €ì¥ì¸ì§€ ì—…ë¡œë“œì¸ì§€) ì„œë²„ êµ¬í˜„ì— ë”°ë¼ ë‹¬ë¼ìš”.
*/
async function publishNow(){
  const blog=getSelectedBlog();
  const title=getSelectedTitle();
  const html = document.getElementById("finalBody")?.textContent?.trim() || "";

  if(!blog || !title){ alert("ë¸”ë¡œê·¸ì™€ ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
  if(!html){ alert("ë¨¼ì € AI ìƒì„± í›„ ë°œí–‰í•˜ì„¸ìš”!"); return; }

  setProgress(10);
  logInfo("ğŸš€ ì¦‰ì‹œë°œí–‰ ìš”ì²­...");
  const payload={
    blog_type: blog.type,
    blog_url: blog.url,
    category: selectedCat,
    topic: title,
    html: html
  };

  try{
    const res=await fetch(API_BASE+"/api/publish/now",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    let j={};
    try{ j = await res.json(); }catch(e){}

    if(!res.ok){
      setProgress(0);
      logErr("ë°œí–‰ ì‹¤íŒ¨: " + (j.error || j.message || "unknown"));
      alert("ë°œí–‰ ì‹¤íŒ¨: " + (j.error || j.message || "unknown"));
      return;
    }

    setProgress(100);
    logOk(j.message || "ë°œí–‰ ìš”ì²­ ì™„ë£Œ");
    alert(j.message || "ë°œí–‰ ìš”ì²­ ì™„ë£Œ");

  }catch(e){
    setProgress(0);
    logErr("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
  }
}

/* ---------------- init ---------------- */
loadBlogsToSelect();
renderTopics();
</script>
</body>
</html>
