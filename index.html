<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BaseOne</title>
  <style>
    :root{
      --bg:#0f1630;--panel:rgba(255,255,255,.06);--panel2:rgba(255,255,255,.08);
      --text:#f8faff;--muted:rgba(248,250,255,.75);--border:rgba(255,255,255,.14);
      --primary:#7aa7ff;--good:#38e1c1;--danger:#ff7b7b;--shadow:0 10px 24px rgba(0,0,0,.22);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg),#0a1022);color:var(--text);font-size:13px}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 4px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--good));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;box-shadow:var(--shadow)}
    .title{font-size:18px;font-weight:900;line-height:1}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .box{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:16px;margin:10px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    input,select,textarea{padding:9px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:12.5px}
    select{min-width:320px}
    textarea{width:100%;min-height:160px;line-height:1.6}
    .btn{padding:8px 11px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:900;font-size:12px}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#2f6bff);border:none;color:#fff}
    .btn.good{background:linear-gradient(135deg,var(--good),#1fb6ff);border:none;color:#fff}
    .btn.danger{background:rgba(255,107,107,.10);border:1px solid rgba(255,107,107,.35);color:var(--danger)}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    .cat{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;cursor:pointer}
    .cat:hover{border-color:rgba(122,167,255,.55)}
    .list{max-height:320px;overflow:auto;margin-top:10px;padding-right:6px}
    .item{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px;cursor:pointer}
    .item.active{border-color:rgba(122,167,255,.85);box-shadow:0 0 0 2px rgba(122,167,255,.18);background:linear-gradient(135deg,rgba(122,167,255,.12),rgba(56,225,193,.10))}
    .itemTitle{font-weight:900}
    .itemMeta{font-size:11.5px;color:var(--muted);margin-top:4px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:900px){.two{grid-template-columns:1fr}}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
    .pre{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:180px;white-space:pre-wrap;overflow:auto;background:rgba(0,0,0,.10)}
    .iframeWrap{margin-top:8px;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:320px}
    iframe{width:100%;height:320px;border:0}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BaseOne</div>
        <div class="subtitle">ìˆ˜ìµí˜• ì£¼ì œ â†’ Gemini ìƒì„± â†’ ë¯¸ë¦¬ë³´ê¸° â†’ ë¸”ë¡œê·¸ìŠ¤íŒŸ ìë™ë°œí–‰</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill">ğŸ›°ï¸ ì„œë²„ <b id="sv">-</b></span>
      <span class="pill">ğŸ” OAuth <b id="oauth">-</b></span>
      <a href="/settings"><button class="btn">âš™ï¸ ì„¤ì •</button></a>
      <button class="btn" onclick="loadBloggerBlogs()">ğŸ—‚ï¸ ë‚´ ë¸”ë¡œê·¸</button>
    </div>
  </div>

  <!-- Blog select -->
  <div class="box">
    <div class="row">
      <div>
        <b>1) ë¸”ë¡œê·¸ìŠ¤íŒŸ ë¸”ë¡œê·¸ ì„ íƒ</b>
        <div class="small">OAuth ì—°ê²° í›„ â€œë‚´ ë¸”ë¡œê·¸â€ë¥¼ ëˆ„ë¥´ë©´ blog_id í¬í•¨ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="blogSelect"></select>
        <button class="btn" onclick="oauthConnect()">ğŸ” OAuth</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">âœ… í˜„ì¬ ì„ íƒ: <b id="blogNow">-</b></div>
  </div>

  <!-- Topics -->
  <div class="box">
    <div class="row">
      <div>
        <b>2) ìˆ˜ìµí˜• ì£¼ì œ</b>
        <div class="small">ì¹´í…Œê³ ë¦¬ ëˆ„ë¥´ë©´ ë¡œì»¬ ì£¼ì œ ìƒì„± / â€œGemini ì£¼ì œâ€ëŠ” Geminië¡œ ëˆ ë˜ëŠ” ì œëª© ë½‘ê¸°</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="filter" placeholder="ğŸ” ê²€ìƒ‰" oninput="renderTopics()">
        <input id="topicCount" type="number" min="5" max="60" value="30" style="width:120px" />
        <button class="btn" onclick="makeLocalTopics()">âš¡ ë¡œì»¬ ì£¼ì œ</button>
        <button class="btn primary" onclick="makeMoneyTopics()">ğŸ’° Gemini ì£¼ì œ</button>
        <button class="btn primary" onclick="aiGenerate()">âœ¨ ê¸€ ìƒì„±</button>
      </div>
    </div>

    <div class="grid" id="catGrid"></div>
    <div class="list" id="topicList"></div>
  </div>

  <!-- Preview + publish -->
  <div class="box" id="previewBox" style="display:none">
    <div class="row">
      <div>
        <b>3) ë¯¸ë¦¬ë³´ê¸° / ë°œí–‰</b>
        <div class="small" id="previewMeta">-</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn good" onclick="publishNow()">ğŸš€ ë¸”ë¡œê·¸ìŠ¤íŒŸ ì¦‰ì‹œë°œí–‰</button>
        <button class="btn" onclick="copyHtml()">ğŸ“‹ HTML ë³µì‚¬</button>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <div style="font-weight:900">ğŸ“ ë³¸ë¬¸(HTML)</div>
        <div class="pre" id="finalBody"></div>
      </div>
      <div class="card">
        <div style="font-weight:900">ğŸ–¼ï¸ ì´ë¯¸ì§€</div>
        <div class="pre" id="finalImage"></div>
        <div style="margin-top:10px">
          <img id="previewImg" alt="preview" style="width:100%;border-radius:12px;border:1px solid var(--border);display:none"/>
          <div class="small" id="imgHint" style="margin-top:8px">ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ì•„ë˜ì— ë³´ì…ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:900">ğŸ‘€ HTML ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="iframeWrap"><iframe id="previewIframe"></iframe></div>
    </div>
  </div>
</div>

<script>
const KEY="baseone_settings_v4";

function settings(){ return JSON.parse(localStorage.getItem(KEY) || "{}"); }
function apiBase(){ return (settings().backend || location.origin).replace(/\/+$/,""); }
document.getElementById("sv").textContent = apiBase();

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* OAuth status */
async function checkOauth(){
  try{
    const res = await fetch(apiBase()+"/api/oauth/status");
    const j = await res.json();
    document.getElementById("oauth").textContent = j.connected ? "OK" : "NO";
  }catch(e){
    document.getElementById("oauth").textContent = "ERR";
  }
}
checkOauth();

function oauthConnect(){
  window.open(apiBase()+"/oauth/start", "_blank");
}

/* Blog list */
let bloggerBlogs = [];
function getSelectedBlog(){
  const v=document.getElementById("blogSelect").value;
  if(!v) return null;
  try{ return JSON.parse(v); }catch(e){ return null; }
}
function updateBlogNow(){
  const b=getSelectedBlog();
  document.getElementById("blogNow").textContent = b ? `${b.name} / ${b.url} / (id:${b.id})` : "-";
}

async function loadBloggerBlogs(){
  try{
    const res = await fetch(apiBase()+"/api/blogger/blogs");
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: OAuth ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
      return;
    }
    bloggerBlogs = j.items || [];

    // ì„¤ì •ì— blogspot_urlsê°€ ìˆìœ¼ë©´ ê·¸ URLë§Œ í•„í„°
    const allow = (settings().blogspot_urls||[]).map(x=>x.trim()).filter(Boolean);
    if(allow.length){
      bloggerBlogs = bloggerBlogs.filter(b => allow.includes(b.url));
    }

    const sel=document.getElementById("blogSelect");
    sel.innerHTML="";
    if(!bloggerBlogs.length){
      const opt=document.createElement("option");
      opt.value="";
      opt.textContent="(ë¸”ë¡œê·¸ ì—†ìŒ) ì„¤ì •ì˜ ë¸”ë¡œê·¸ìŠ¤íŒŸ ì£¼ì†Œ ì œí•œ í™•ì¸";
      sel.appendChild(opt);
      updateBlogNow();
      return;
    }

    bloggerBlogs.forEach((b,i)=>{
      const opt=document.createElement("option");
      opt.value = JSON.stringify(b); // {id,name,url}
      opt.textContent = `ğŸŸ¦ ${i+1}. ${b.name} (${b.url})`;
      sel.appendChild(opt);
    });
    sel.selectedIndex=0;
    updateBlogNow();
    alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}
document.addEventListener("change",(e)=>{
  if(e.target && e.target.id==="blogSelect") updateBlogNow();
});

/* Categories + Topics */
const CATS=[
  {k:"ëˆ/ì¬í…Œí¬", s:"í™˜ê¸‰/ì ˆì„¸/ê³ ì •ë¹„"},
  {k:"ë³´í—˜", s:"ë³´í—˜ë£Œ ì ˆì•½/íŠ¹ì•½"},
  {k:"ëŒ€ì¶œ/ê¸ˆë¦¬", s:"ì´ì/ê°ˆì•„íƒ€ê¸°"},
  {k:"ì—°ë§ì •ì‚°", s:"ê³µì œ/í™˜ê¸‰"},
  {k:"ì •ë¶€ì§€ì›", s:"ì§€ì›ê¸ˆ/ì •ì±…"},
  {k:"ì¹´ë“œí˜œíƒ", s:"ìºì‹œë°±/í¬ì¸íŠ¸"},
  {k:"í†µì‹ ë¹„", s:"ìš”ê¸ˆì œ/í• ì¸"},
  {k:"ì „ê¸°Â·ê°€ìŠ¤", s:"ìš”ê¸ˆ ì ˆì•½"},
];
const catGrid=document.getElementById("catGrid");
let selectedCat="ëˆ/ì¬í…Œí¬";
CATS.forEach(obj=>{
  const d=document.createElement("div");
  d.className="cat";
  d.onclick=()=>{ selectedCat=obj.k; makeLocalTopics(); };
  d.innerHTML = `<b>${obj.k}</b><div class="small">${obj.s}</div>`;
  catGrid.appendChild(d);
});

let topics=[]; // {id,title}
let selectedTopicId="";

function makeLocalTopics(){
  const hooks=["ì´ˆë³´ë„ ë°”ë¡œ ë˜ëŠ”","ëˆ ìƒˆëŠ” êµ¬ë© ë§‰ëŠ”","ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©","í—·ê°ˆë¦¬ê¸° ì‰¬ìš´","ì •ë¦¬ í•œ ë²ˆì—","ì‹¤ìˆ˜ ì¤„ì´ëŠ”"];
  const bases=["í™˜ê¸‰ë°›ëŠ” ë°©ë²• ì´ì •ë¦¬","ê³ ì •ë¹„ ì¤„ì´ëŠ” ìˆœì„œ","ë†“ì¹˜ë©´ ì†í•´ ë³´ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸","ì‹ ì²­ ì¡°ê±´/ëŒ€ìƒ ì •ë¦¬","ì ˆì„¸ í¬ì¸íŠ¸","ì‹¤ìˆ˜ TOP 7","ë¹„êµ ê¸°ì¤€","í•œ ë‹¬ì— ì•„ë¼ëŠ” ë°©ë²•"];
  const out=new Set();
  while(out.size<24){
    const h=hooks[Math.floor(Math.random()*hooks.length)];
    const b=bases[Math.floor(Math.random()*bases.length)];
    out.add(`${h} ${selectedCat} ${b}`);
  }
  topics=[...out].map((t,i)=>({id:`L_${Date.now()}_${i}`, title:t}));
  selectedTopicId=topics[0]?.id||"";
  renderTopics();
}

function renderTopics(){
  const q=(document.getElementById("filter").value||"").trim().toLowerCase();
  const box=document.getElementById("topicList");
  box.innerHTML="";
  let arr=topics.slice();
  if(q) arr=arr.filter(x=>x.title.toLowerCase().includes(q));
  if(!arr.length){
    box.innerHTML=`<div class="small">ì£¼ì œ ì—†ìŒ</div>`;
    return;
  }
  arr.forEach(it=>{
    const d=document.createElement("div");
    d.className="item"+(it.id===selectedTopicId?" active":"");
    d.onclick=()=>{ selectedTopicId=it.id; renderTopics(); };
    d.innerHTML=`
      <div style="flex:1">
        <div class="itemTitle">${escapeHtml(it.title)}</div>
        <div class="itemMeta">ğŸ·ï¸ ${escapeHtml(selectedCat)}</div>
      </div>
      <button class="btn" onclick="event.stopPropagation(); navigator.clipboard.writeText('${it.title.replaceAll("'","\\'")}'); alert('ë³µì‚¬ ì™„ë£Œ!');">ë³µì‚¬</button>
    `;
    box.appendChild(d);
  });
}

function getSelectedTitle(){
  return topics.find(x=>x.id===selectedTopicId)?.title || "";
}

/* Gemini money topics */
async function makeMoneyTopics(){
  const d=settings();
  if(!d.gemini_key){ alert("ì„¤ì •ì—ì„œ GEMINI_API_KEY ì €ì¥ ë¨¼ì €"); return; }
  const count = Math.max(5, Math.min(60, Number(document.getElementById("topicCount").value||30)));
  try{
    const res = await fetch(apiBase()+"/api/topics/money",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ gemini_key:d.gemini_key, gemini_model:d.gemini_model, count })
    });
    const j=await res.json();
    if(!res.ok || !j.ok){ alert("ì£¼ì œ ìƒì„± ì‹¤íŒ¨: "+(j.error||"")); return; }
    topics=(j.items||[]).slice(0,count).map((t,i)=>({id:`G_${Date.now()}_${i}`, title:String(t)}));
    selectedTopicId=topics[0]?.id||"";
    renderTopics();
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}

/* Generate article */
async function aiGenerate(){
  const title=getSelectedTitle();
  if(!title){ alert("ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }

  const d=settings();
  if(!d.gemini_key){ alert("ì„¤ì •ì—ì„œ GEMINI_API_KEY ì €ì¥ ë¨¼ì €"); return; }

  const payload={
    topic: title,
    category: selectedCat,
    gemini_key: d.gemini_key,
    gemini_model: d.gemini_model || "gemini-1.5-flash",
    img_provider: "pexels",
    pexels_key: d.pexels_key || ""
  };

  try{
    const res=await fetch(apiBase()+"/api/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j=await res.json();
    if(!res.ok || !j.ok){
      alert("ìƒì„± ì‹¤íŒ¨: " + (j.error || "unknown"));
      return;
    }

    const html = (j.html || "").trim();
    if(!html){ alert("ìƒì„±ì€ ëëŠ”ë° HTMLì´ ë¹„ì—ˆì–´ìš”. server.py /api/generate í™•ì¸"); return; }

    document.getElementById("finalBody").textContent = html;
    document.getElementById("finalImage").textContent =
      `pexels_query: ${j.pexels_query||""}\nimage_prompt: ${j.image_prompt||""}\nimage_url: ${j.image_url||""}`;

    document.getElementById("previewMeta").textContent =
      `ğŸ§  ${j.topic} / ğŸ·ï¸ ${j.category} / â±ï¸ ${j.generated_at || ""}`;

    document.getElementById("previewIframe").srcdoc =
      `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style>
      </head><body>${html}</body></html>`;

    const img=document.getElementById("previewImg");
    const hint=document.getElementById("imgHint");
    if(j.image_url){
      img.src=j.image_url;
      img.style.display="block";
      hint.style.display="none";
    }else{
      img.style.display="none";
      hint.style.display="block";
    }

    document.getElementById("previewBox").style.display="block";

  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì„¤ì •ì˜ ì„œë²„ ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
  }
}

function copyHtml(){
  const html = document.getElementById("finalBody")?.textContent || "";
  if(!html){ alert("ë³µì‚¬í•  HTMLì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  navigator.clipboard.writeText(html);
  alert("HTML ë³µì‚¬ ì™„ë£Œ!");
}

/* Publish (Blogger) */
async function publishNow(){
  const blog = getSelectedBlog();
  const title = getSelectedTitle();
  const html = (document.getElementById("finalBody")?.textContent || "").trim();

  if(!blog){ alert("ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš” (ë‚´ ë¸”ë¡œê·¸ ë²„íŠ¼)"); return; }
  if(!title){ alert("ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
  if(!html){ alert("ë¨¼ì € ê¸€ ìƒì„±í•˜ì„¸ìš”"); return; }

  try{
    const res = await fetch(apiBase()+"/api/blogger/post",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ blog_id: blog.id, title, html })
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("ë°œí–‰ ì‹¤íŒ¨: " + (j.error || "unknown"));
      return;
    }
    alert("ë°œí–‰ ì™„ë£Œ!\n" + (j.url || ""));
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}

/* init */
makeLocalTopics();
</script>
</body>
</html>
