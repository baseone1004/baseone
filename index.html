<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BaseOne</title>
  <style>
    :root{--bg:#0f1630;--panel:rgba(255,255,255,.06);--panel2:rgba(255,255,255,.08);--text:#f8faff;--muted:rgba(248,250,255,.75);--border:rgba(255,255,255,.14);--primary:#7aa7ff;--good:#38e1c1;--danger:#ff7b7b;--shadow:0 10px 24px rgba(0,0,0,.22);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg),#0a1022);color:var(--text);font-size:13px}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 4px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--good));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;box-shadow:var(--shadow);}
    .title{font-size:18px;font-weight:900;line-height:1}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--muted);font-size:12px;}
    .box{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:16px;margin:10px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    input,select,textarea{padding:9px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:12.5px}
    select{min-width:360px}
    .btn{padding:8px 11px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:900;font-size:12px}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#2f6bff);border:none;color:#fff}
    .btn.good{background:linear-gradient(135deg,var(--good),#1fb6ff);border:none;color:#fff}
    .btn.danger{background:rgba(255,107,107,.10);border:1px solid rgba(255,107,107,.35);color:var(--danger)}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    .cat{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;cursor:pointer}
    .cat:hover{border-color:rgba(122,167,255,.55)}
    .list{max-height:320px;overflow:auto;margin-top:10px;padding-right:6px}
    .item{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px;cursor:pointer}
    .item.active{border-color:rgba(122,167,255,.85);box-shadow:0 0 0 2px rgba(122,167,255,.18);background:linear-gradient(135deg,rgba(122,167,255,.12),rgba(56,225,193,.10))}
    .itemTitle{font-weight:900}
    .itemMeta{font-size:11.5px;color:var(--muted);margin-top:4px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:900px){.two{grid-template-columns:1fr}}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
    .pre{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:180px;white-space:pre-wrap;overflow:auto;background:rgba(0,0,0,.10)}
    .iframeWrap{margin-top:8px;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:340px}
    iframe{width:100%;height:340px;border:0}
    img{max-width:100%}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BaseOne</div>
        <div class="subtitle">ì£¼ì œ â†’ AI ìƒì„±(Gemini/GPT) â†’ ì´ë¯¸ì§€(Pexels) â†’ ì¦‰ì‹œë°œí–‰/ì˜ˆì•½ë°œí–‰(ë¸”ë¡œê·¸ìŠ¤íŒŸ)</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill">ğŸ›°ï¸ ì„œë²„ <b id="sv">-</b></span>
      <a href="/settings"><button class="btn">âš™ï¸ ì„¤ì •</button></a>
      <button class="btn" onclick="refreshTasks()">ğŸ“‹ ì˜ˆì•½ëª©ë¡</button>
    </div>
  </div>

  <div class="box">
    <div class="row">
      <div>
        <b>1) OAuth + ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</b>
        <div class="small">OAuth ì—°ê²° í›„ â€œë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°â€ â†’ blog_id í™•ë³´ â†’ ìë™ë°œí–‰ ê°€ëŠ¥</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="oauthConnect()">ğŸ” OAuth ì—°ê²°</button>
        <button class="btn primary" onclick="loadMyBlogs()">ğŸ“¥ ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
    <div class="small" style="margin-top:8px">í˜„ì¬ ì„ íƒ: <b id="activeBlogText">-</b></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <select id="blogSelect"></select>
      <button class="btn good" onclick="setActiveBlog()">âœ… ì„ íƒ</button>
    </div>
    <div class="small" style="margin-top:8px" id="oauthState">-</div>
  </div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  <input id="kwSeed" placeholder="í‚¤ì›Œë“œ ì‹œë“œ (ì˜ˆ: ì •ë¶€ì§€ì›ê¸ˆ, ì†Œìƒê³µì¸, ì—°ë§ì •ì‚°)" style="min-width:360px"/>
  <input id="kwCount" type="number" value="30" min="10" max="80" style="width:110px"/>
  <button class="btn primary" onclick="collectKeywords()">ğŸ” ìˆ˜ìµí˜• í‚¤ì›Œë“œ ìë™ìˆ˜ì§‘</button>
  <button class="btn" onclick="applyTitlesAsTopics()">â• ì œëª©ì„ ì£¼ì œë¡œ ì¶”ê°€</button>
</div>
<div class="small" id="kwHint" style="margin-top:6px"></div>
<div class="list" id="kwList" style="max-height:240px"></div>

  <div class="box">
    <div class="row">
      <div>
        <b>2) ì£¼ì œ ìƒì„±</b>
        <div class="small">ì¹´í…Œê³ ë¦¬ í´ë¦­ â†’ ì£¼ì œ ìƒì„±. ì²´í¬ëœ ê²ƒë§Œ ëŒ€ëŸ‰ ìƒì„±/ì˜ˆì•½.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="filter" placeholder="ğŸ” ê²€ìƒ‰" oninput="renderTopics()">
        <button class="btn" onclick="makeLocalTopics()">âš¡ ë¡œì»¬ ì£¼ì œ</button>
        <button class="btn primary" onclick="makeAiTopics()">ğŸ’° AI ì£¼ì œ(ì„¤ì •í‚¤ í•„ìš”)</button>
      </div>
    </div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  <button class="btn primary" onclick="generateSingle()">âœ¨ ì„ íƒ ì£¼ì œ ê¸€ ìƒì„±</button>
  <button class="btn good" onclick="publishNow()">ğŸš€ ì¦‰ì‹œë°œí–‰(ì„ íƒ ê¸€)</button>
  <button class="btn" onclick="scheduleOne()">ğŸ•’ ì˜ˆì•½ë°œí–‰(ì„ íƒ ê¸€)</button>
  <input id="runAtOne" type="datetime-local" />
</div>

<div class="small" style="margin-top:8px">
  ì‚¬ìš©ìˆœì„œ: â‘  ì£¼ì œ í´ë¦­ â†’ â‘¡ â€˜ì„ íƒ ì£¼ì œ ê¸€ ìƒì„±â€™ â†’ â‘¢ â€˜ì¦‰ì‹œë°œí–‰â€™ ë˜ëŠ” â€˜ì˜ˆì•½ë°œí–‰â€™
</div>

    <div class="grid" id="catGrid"></div>
    <div class="list" id="topicList"></div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn primary" onclick="bulkGenerate()">âœ¨ ê¸€ ìƒì„±(ì²´í¬ ëŒ€ëŸ‰)</button>
      <button class="btn good" onclick="bulkSchedule()">ğŸ—“ï¸ ì˜ˆì•½ë°œí–‰(ì²´í¬ ëŒ€ëŸ‰)</button>

      <span class="small">ì‹œì‘ì‹œê°„</span>
      <input id="bulkStart" type="datetime-local"/>
      <span class="small">ê°„ê²©(ë¶„)</span>
      <input id="bulkGapMin" type="number" min="5" value="120" style="width:110px"/>
      <span class="small">ê°œìˆ˜</span>
      <input id="bulkHowMany" type="number" min="1" value="10" style="width:90px"/>
    </div>
  </div>

  <div class="box" id="previewBox" style="display:none">
    <div class="row">
      <div>
        <b>3) ë¯¸ë¦¬ë³´ê¸°(ë‹¨ê±´)</b>
        <div class="small" id="previewMeta">-</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" onclick="generateSingle()">âœ¨ ë‹¤ì‹œ ìƒì„±</button>
        <button class="btn good" onclick="publishNow()">ğŸš€ ì¦‰ì‹œë°œí–‰</button>
        <button class="btn" onclick="scheduleOne()">ğŸ•’ ì´ ê¸€ ì˜ˆì•½</button>
        <input id="runAtOne" type="datetime-local"/>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <div style="font-weight:900">ğŸ“ HTML</div>
        <div class="pre" id="finalBody"></div>
      </div>
      <div class="card">
        <div style="font-weight:900">ğŸ–¼ï¸ ì´ë¯¸ì§€</div>
        <div class="pre" id="finalImage"></div>
        <img id="previewImg" style="display:none;border-radius:12px;border:1px solid var(--border);margin-top:10px" alt="preview"/>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:900">ğŸ‘€ HTML ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="iframeWrap"><iframe id="previewIframe"></iframe></div>
    </div>
  </div>

  <div class="box">
    <div class="row">
      <div>
        <b>4) ì˜ˆì•½ë°œí–‰ ëª©ë¡</b>
        <div class="small">pending/running/ok/err</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="refreshTasks()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="taskList" class="small" style="margin-top:10px">-</div>
  </div>
</div>

<script>
/* ------------ settings ------------ */
const SKEY="baseone_settings_v5";
function S(){ return JSON.parse(localStorage.getItem(SKEY)||"{}"); }
function apiBase(){
  const b=(S().backend || location.origin).trim().replace(/\/+$/,"");
  return b;
}
document.getElementById("sv").textContent = apiBase();
function esc(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}

/* ------------ state ------------ */
let bloggerBlogs=[];
let activeBlog=null;

let topics=[]; // {id,title,checked,html,image_url,image_prompt}
let selectedCat="ëˆ/ì¬í…Œí¬";
let selectedTopicId="";

/* ------------ categories ------------ */
const CATS=[
  {k:"ëˆ/ì¬í…Œí¬", s:"ì ˆì„¸/ê³ ì •ë¹„"},
  {k:"ì •ë¶€ì§€ì›", s:"ì§€ì›ê¸ˆ/ì •ì±…"},
  {k:"ì¹´ë“œí˜œíƒ", s:"ìºì‹œë°±/í¬ì¸íŠ¸"},
  {k:"ëŒ€ì¶œ/ê¸ˆë¦¬", s:"ê°ˆì•„íƒ€ê¸°/ì´ì"},
  {k:"ì—°ë§ì •ì‚°", s:"ê³µì œ/í™˜ê¸‰"},
  {k:"í†µì‹ ë¹„", s:"ìš”ê¸ˆì œ/í• ì¸"},
  {k:"ì „ê¸°Â·ê°€ìŠ¤", s:"ìš”ê¸ˆ ì ˆì•½"},
  {k:"ë³´í—˜", s:"íŠ¹ì•½/ë³´í—˜ë£Œ"},
];
const catGrid=document.getElementById("catGrid");
CATS.forEach(c=>{
  const d=document.createElement("div");
  d.className="cat";
  d.onclick=()=>{selectedCat=c.k; makeLocalTopics();};
  d.innerHTML=`<b>${esc(c.k)}</b><div class="small">${esc(c.s)}</div>`;
  catGrid.appendChild(d);
});

/* ------------ oauth status ------------ */
async function refreshOauth(){
  try{
    const r=await fetch(apiBase()+"/api/oauth/status");
    const j=await r.json();
    document.getElementById("oauthState").textContent = j.connected ? "ğŸ”“ OAuth connected" : "ğŸ”’ OAuth not connected";
  }catch(e){
    document.getElementById("oauthState").textContent = "OAuth status: (ì„œë²„ ì—°ê²° ì‹¤íŒ¨)";
  }
}
function oauthConnect(){
  window.open(apiBase()+"/oauth/start","_blank");
}

/* ------------ blog load ------------ */
function blogFilterAllowed(url){
  const allow = (S().blogspot_urls||[]).map(x=>String(x).trim()).filter(Boolean);
  if(!allow.length) return true; // ì œí•œì´ ì—†ìœ¼ë©´ ì „ë¶€ í—ˆìš©
  return allow.includes(url);
}

async function loadMyBlogs(){
  await refreshOauth();
  try{
    const r=await fetch(apiBase()+"/api/blogger/blogs");
    const j=await r.json();
    if(!r.ok || !j.ok){
      alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: OAuth ì—°ê²°ì„ ë¨¼ì € í•˜ì„¸ìš”.");
      return;
    }
    bloggerBlogs=(j.items||[]).filter(b=>blogFilterAllowed(b.url));

    if(!bloggerBlogs.length){
      const allow=(S().blogspot_urls||[]).join("\\n");
      alert("ë¶ˆëŸ¬ì˜¨ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. (ì„¤ì •ì˜ blogspot_urls ì œí•œì„ í™•ì¸)\\n\\ní˜„ì¬ ì œí•œê°’:\\n"+(allow||"(ë¹„ì–´ìˆìŒ)"));
      renderBlogSelect();
      return;
    }
    // active auto
    if(!activeBlog){
      activeBlog=bloggerBlogs[0];
      localStorage.setItem("baseone_active_blog_id", activeBlog.id);
    }
    renderBlogSelect();
    alert("ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ!");
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}

function renderBlogSelect(){
  const sel=document.getElementById("blogSelect");
  sel.innerHTML="";
  if(!bloggerBlogs.length){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="(ë¸”ë¡œê·¸ ì—†ìŒ) ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ë¨¼ì €";
    sel.appendChild(opt);
    document.getElementById("activeBlogText").textContent="-";
    return;
  }

  const savedId=localStorage.getItem("baseone_active_blog_id");
  activeBlog = bloggerBlogs.find(b=>b.id===savedId) || activeBlog || bloggerBlogs[0];

  bloggerBlogs.forEach((b,i)=>{
    const opt=document.createElement("option");
    opt.value=JSON.stringify(b);
    opt.textContent=`${i+1}. ${b.name} (${b.url})`;
    sel.appendChild(opt);
  });

  // select active
  for(let i=0;i<sel.options.length;i++){
    try{
      const b=JSON.parse(sel.options[i].value);
      if(activeBlog && b.id===activeBlog.id){ sel.selectedIndex=i; break; }
    }catch(e){}
  }
  document.getElementById("activeBlogText").textContent = activeBlog ? `${activeBlog.name} / ${activeBlog.url}` : "-";
}

function setActiveBlog(){
  const v=document.getElementById("blogSelect").value;
  if(!v){ alert("ì„ íƒí•  ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  activeBlog=JSON.parse(v);
  localStorage.setItem("baseone_active_blog_id", activeBlog.id);
  renderBlogSelect();
}

/* ------------ topics ------------ */
function makeLocalTopics(){
  const hooks=["ì´ˆë³´ë„ ë°”ë¡œ ë˜ëŠ”","ëˆ ìƒˆëŠ” êµ¬ë© ë§‰ëŠ”","ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©","í—·ê°ˆë¦¬ê¸° ì‰¬ìš´","ì •ë¦¬ í•œ ë²ˆì—","ì‹¤ìˆ˜ ì¤„ì´ëŠ”"];
  const bases=["í™˜ê¸‰ë°›ëŠ” ë°©ë²• ì´ì •ë¦¬","ê³ ì •ë¹„ ì¤„ì´ëŠ” ìˆœì„œ","ë†“ì¹˜ë©´ ì†í•´ ì²´í¬ë¦¬ìŠ¤íŠ¸","ì‹ ì²­ ì¡°ê±´/ëŒ€ìƒ ì •ë¦¬","ì ˆì„¸ í¬ì¸íŠ¸","ì‹¤ìˆ˜ TOP 7","ë¹„êµ ê¸°ì¤€","í•œ ë‹¬ì— ì•„ë¼ëŠ” ë°©ë²•"];
  const out=new Set();
  while(out.size<24){
    const h=hooks[Math.floor(Math.random()*hooks.length)];
    const b=bases[Math.floor(Math.random()*bases.length)];
    out.add(`${h} ${selectedCat} ${b}`);
  }
  topics=[...out].map((t,i)=>({id:`L_${Date.now()}_${i}`, title:t, checked:(i<10), html:"", image_url:"", image_prompt:""}));
  selectedTopicId=topics[0]?.id||"";
  renderTopics();
}

async function makeAiTopics(){
  const d=S();
  if(!d.gemini_key && !d.openai_key){
    alert("ì„¤ì •ì—ì„œ GEMINI_API_KEY ë˜ëŠ” OPENAI_API_KEYë¥¼ ë„£ì–´ì£¼ì„¸ìš”.");
    return;
  }
  // ê°„ë‹¨: ë¡œì»¬ ì£¼ì œ ìš°ì„ . (AI ì£¼ì œ APIê¹Œì§€ ì›í•˜ë©´ ë§í•´ì¤˜. ì„œë²„ì— /api/topics/money ë§Œë“¤ì–´ì¤„ê²Œ)
  makeLocalTopics();
  alert("í˜„ì¬ ë²„ì „ì€ AI ì£¼ì œ ìƒì„± ëŒ€ì‹  ë¡œì»¬ ì£¼ì œ ìƒì„±ìœ¼ë¡œ ëŒ€ì²´í–ˆìŠµë‹ˆë‹¤. (ì›í•˜ë©´ AI ì£¼ì œ APIë„ ì¶”ê°€í•´ì¤„ê²Œ)");
}

function renderTopics(){
  const q=(document.getElementById("filter").value||"").trim().toLowerCase();
  const box=document.getElementById("topicList");
  box.innerHTML="";
  let arr=topics.slice();
  if(q) arr=arr.filter(x=>x.title.toLowerCase().includes(q));
  if(!arr.length){
    box.innerHTML=`<div class="small">ì£¼ì œ ì—†ìŒ</div>`;
    return;
  }
  arr.forEach(it=>{
    const d=document.createElement("div");
    d.className="item"+(it.id===selectedTopicId?" active":"");
    d.onclick=()=>{ selectedTopicId=it.id; showPreview(it); renderTopics(); };
    d.innerHTML=`
      <div style="flex:1">
        <div class="itemTitle">
          <input type="checkbox" ${it.checked?"checked":""}
            onclick="event.stopPropagation(); itToggle('${it.id}')"
            style="transform:translateY(1px);margin-right:8px"/>
          ${esc(it.title)}
        </div>
        <div class="itemMeta">ğŸ·ï¸ ${esc(selectedCat)} Â· ${it.html ? "âœ… ìƒì„±ë¨":"â³ ë¯¸ìƒì„±"}</div>
      </div>
      <button class="btn" onclick="event.stopPropagation(); navigator.clipboard.writeText('${it.title.replaceAll("'","\\'")}'); alert('ë³µì‚¬ ì™„ë£Œ!');">ë³µì‚¬</button>
    `;
    box.appendChild(d);
  });
}
function itToggle(id){
  const t=topics.find(x=>x.id===id);
  if(t) t.checked=!t.checked;
}
function curTopic(){ return topics.find(x=>x.id===selectedTopicId) || null; }

/* ------------ generate ------------ */
async function generateOne(t){
  const d=S();
  const writer = (d.writer || "gemini"); // gemini | gpt
  const payload={
    topic: t.title,
    category: selectedCat,
    writer,
    gemini_key: d.gemini_key || "",
    gemini_model: d.gemini_model || "gemini-1.5-flash",
    openai_key: d.openai_key || "",
    openai_model: d.openai_model || "gpt-4o-mini",
    img_provider: d.img_provider || "pexels",
    pexels_key: d.pexels_key || ""
  };
  const r=await fetch(apiBase()+"/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=> ({}));
  if(!r.ok || !j.ok) throw new Error(j.error||"generate failed");
  t.html=j.html||"";
  t.image_url=j.image_url||"";
  t.image_prompt=j.image_prompt||"";
}
async function generateSingle(){
  const t=curTopic();
  if(!t) return alert("ì£¼ì œ ì„ íƒ");
  try{
    await generateOne(t);
    showPreview(t);
    renderTopics();
    alert("ìƒì„± ì™„ë£Œ!");
  }catch(e){
    alert("ìƒì„± ì‹¤íŒ¨: "+e.message);
  }
}
async function bulkGenerate(){
  const list=topics.filter(x=>x.checked);
  if(!list.length) return alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
  const targets=list.filter(x=>!x.html);
  if(!targets.length) return alert("ì´ë¯¸ ë‹¤ ìƒì„±ëìŠµë‹ˆë‹¤.");
  if(!confirm(`ë¯¸ìƒì„± ${targets.length}ê°œë¥¼ ìƒì„±í• ê¹Œìš”?`)) return;
  for(let i=0;i<targets.length;i++){
    try{ await generateOne(targets[i]); }
    catch(e){ alert("ì¤‘ë‹¨: "+e.message); break; }
  }
  renderTopics();
  alert("ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ(ë˜ëŠ” ì¤‘ë‹¨).");
}

/* ------------ preview ------------ */
function showPreview(t){
  if(!t || !t.html){
    document.getElementById("previewBox").style.display="none";
    return;
  }
  document.getElementById("finalBody").textContent=t.html;
  document.getElementById("finalImage").textContent=(t.image_url ? (t.image_prompt+"\\n"+t.image_url) : (t.image_prompt||""));
  document.getElementById("previewMeta").textContent=`ğŸ§  ${t.title} / ğŸ·ï¸ ${selectedCat}`;
  document.getElementById("previewIframe").srcdoc=`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style></head><body>${t.html}</body></html>`;
  const img=document.getElementById("previewImg");
  if(t.image_url){ img.src=t.image_url; img.style.display="block"; }
  else{ img.style.display="none"; }
  document.getElementById("previewBox").style.display="block";
}

/* ------------ publish & schedule ------------ */
async function publishNow(){
  if(!activeBlog || !activeBlog.id) return alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„ ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  const t=curTopic();
  if(!t || !t.html) return alert("ë¨¼ì € ê¸€ì„ ìƒì„±í•˜ì„¸ìš”.");

  const payload={ blog_id: activeBlog.id, title: t.title, html: t.html };
  const r=await fetch(apiBase()+"/api/blogger/post",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=> ({}));
  if(!r.ok || !j.ok) return alert("ë°œí–‰ ì‹¤íŒ¨: "+(j.error||"unknown"));
  alert("ë°œí–‰ ì™„ë£Œ!\\n"+(j.url||""));
}

function toUtcIso(localVal){
  const dt=new Date(localVal);
  return dt.toISOString();
}

async function addTask(run_at_iso, t){
  const payload={platform:"blogspot", blog_id: activeBlog.id, blog_url: activeBlog.url||"", title: t.title, html: t.html, run_at: run_at_iso};
  const r=await fetch(apiBase()+"/api/tasks/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const j=await r.json().catch(()=> ({}));
  if(!r.ok || !j.ok) throw new Error(j.error||"task add failed");
}

async function scheduleOne(){
  if(!activeBlog || !activeBlog.id) return alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„ ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  const t=curTopic();
  if(!t || !t.html) return alert("ë¨¼ì € ê¸€ì„ ìƒì„±í•˜ì„¸ìš”.");
  const v=(document.getElementById("runAtOne").value||"").trim();
  if(!v) return alert("ì˜ˆì•½ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
  try{
    await addTask(toUtcIso(v), t);
    alert("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ!");
    refreshTasks();
  }catch(e){
    alert("ì˜ˆì•½ ì‹¤íŒ¨: "+e.message);
  }
}

async function bulkSchedule(){
  if(!activeBlog || !activeBlog.id) return alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„ ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  const list=topics.filter(x=>x.checked);
  if(!list.length) return alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.");

  const howMany=Math.max(1, Number(document.getElementById("bulkHowMany").value||1));
  const gapMin=Math.max(5, Number(document.getElementById("bulkGapMin").value||120));
  const startVal=(document.getElementById("bulkStart").value||"").trim();
  if(!startVal) return alert("ì‹œì‘ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");

  const selected=list.slice(0,howMany);
  const needGen=selected.filter(x=>!x.html);
  if(needGen.length){
    if(confirm(`ì˜ˆì•½ ëŒ€ìƒ ${selected.length}ê°œ ì¤‘ ${needGen.length}ê°œê°€ ë¯¸ìƒì„±ì…ë‹ˆë‹¤. ë¨¼ì € ìƒì„±í• ê¹Œìš”?`)){
      for(const t of needGen){
        try{ await generateOne(t); }
        catch(e){ return alert("ìƒì„± ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨: "+e.message); }
      }
      renderTopics();
    }else{
      return alert("ë¯¸ìƒì„± ê¸€ì´ ìˆì–´ ì˜ˆì•½ ì¤‘ë‹¨");
    }
  }

  if(!confirm(`${selected.length}ê°œë¥¼ ${gapMin}ë¶„ ê°„ê²©ìœ¼ë¡œ ì˜ˆì•½í• ê¹Œìš”? (ì‹œê°„ ê²¹ì³ë„ OK)`)) return;

  const start=new Date(startVal);
  for(let i=0;i<selected.length;i++){
    const t=selected[i];
    const run=new Date(start.getTime()+i*gapMin*60*1000);
    try{ await addTask(run.toISOString(), t); }
    catch(e){ return alert("ì˜ˆì•½ ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨: "+e.message); }
  }
  alert("ëŒ€ëŸ‰ ì˜ˆì•½ ì €ì¥ ì™„ë£Œ!");
  refreshTasks();
}

/* ------------ tasks list ------------ */
async function refreshTasks(){
  const box=document.getElementById("taskList");
  box.textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    const r=await fetch(apiBase()+"/api/tasks/list");
    const j=await r.json();
    if(!r.ok || !j.ok){ box.textContent="ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"; return; }
    const items=j.items||[];
    if(!items.length){ box.textContent="ì˜ˆì•½ ì—†ìŒ"; return; }
    box.innerHTML = items.slice(0,80).map(it=>{
      const st=it.status;
      const badge = st==="ok"?"âœ…":st==="err"?"âŒ":st==="running"?"ğŸŸ¦":st==="canceled"?"ğŸš«":"â³";
      const url = it.result_url ? `<div><a href="${it.result_url}" target="_blank">ğŸ”— ê²°ê³¼ ë§í¬</a></div>` : "";
      const err = it.error ? `<div style="color:#ffb4b4">ì—ëŸ¬: ${esc(it.error)}</div>` : "";
      const cancelBtn = (st==="pending") ? `<button class="btn danger" onclick="cancelTask(${it.id})">ì·¨ì†Œ</button>` : "";
      return `
        <div style="padding:10px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.06);margin-top:8px">
          <div style="font-weight:900">${badge} [#${it.id}] ${esc(it.title||"")}</div>
          <div class="small">blog_id: ${esc(it.blog_id||"-")} / run_at(UTC): ${esc(it.run_at||"-")}</div>
          ${url}${err}
          <div style="margin-top:6px">${cancelBtn}</div>
        </div>
      `;
    }).join("");
  }catch(e){
    box.textContent="ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
  }
}

async function cancelTask(id){
  if(!confirm("ì´ ì˜ˆì•½ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
  await fetch(apiBase()+`/api/tasks/cancel/${id}`,{method:"POST"});
  refreshTasks();
}

/* ------------ init ------------ */
refreshOauth();
makeLocalTopics();
renderBlogSelect();
renderTopics();
</script>
</body>
</html>


