<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BaseOne</title>
  <style>
    :root{--bg:#0f1630;--panel:rgba(255,255,255,.06);--panel2:rgba(255,255,255,.08);--text:#f8faff;--muted:rgba(248,250,255,.75);--border:rgba(255,255,255,.14);--primary:#7aa7ff;--good:#38e1c1;--danger:#ff7b7b;--shadow:0 10px 24px rgba(0,0,0,.22);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg),#0a1022);color:var(--text);font-size:13px}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 4px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--good));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;box-shadow:var(--shadow);}
    .title{font-size:18px;font-weight:900;line-height:1}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--muted);font-size:12px;}
    .box{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:16px;margin:10px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    input,select,textarea{padding:9px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:12.5px}
    select{min-width:320px}
    textarea{width:100%;min-height:160px;line-height:1.6}
    .btn{padding:8px 11px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:900;font-size:12px}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#2f6bff);border:none;color:#fff}
    .btn.good{background:linear-gradient(135deg,var(--good),#1fb6ff);border:none;color:#fff}
    .btn.danger{background:rgba(255,107,107,.10);border:1px solid rgba(255,107,107,.35);color:var(--danger)}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    .cat{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;cursor:pointer}
    .cat:hover{border-color:rgba(122,167,255,.55)}
    .list{max-height:320px;overflow:auto;margin-top:10px;padding-right:6px}
    .item{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:14px;display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px;cursor:pointer}
    .item.active{border-color:rgba(122,167,255,.85);box-shadow:0 0 0 2px rgba(122,167,255,.18);background:linear-gradient(135deg,rgba(122,167,255,.12),rgba(56,225,193,.10))}
    .itemTitle{font-weight:900}
    .itemMeta{font-size:11.5px;color:var(--muted);margin-top:4px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:900px){.two{grid-template-columns:1fr}}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
    .pre{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:180px;white-space:pre-wrap;overflow:auto;background:rgba(0,0,0,.10)}
    .iframeWrap{margin-top:8px;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:320px}
    iframe{width:100%;height:320px;border:0}

    /* --- Blog tabs --- */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);cursor:pointer;
      display:flex;align-items:center;gap:8px;
      max-width:100%;
    }
    .tab b{white-space:nowrap}
    .tab small{opacity:.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:420px}
    .tab.active{border-color:rgba(122,167,255,.85);box-shadow:0 0 0 2px rgba(122,167,255,.18)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BaseOne</div>
        <div class="subtitle">ìˆ˜ìµí˜• ì£¼ì œ â†’ Gemini ìƒì„± â†’ ë‹¤ì¤‘ ì˜ˆì•½(ê°„ê²©) â†’ ìë™ ì—…ë¡œë“œ(ë¸”ë¡œê·¸ìŠ¤íŒŸ)</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill">ğŸ›°ï¸ ì„œë²„ <b id="sv">-</b></span>
      <a href="/settings"><button class="btn">âš™ï¸ ì„¤ì •</button></a>
      <button class="btn" onclick="refreshTasks()">ğŸ“‹ ì˜ˆì•½ëª©ë¡</button>
    </div>
  </div>

  <div class="box">
    <div class="row">
      <div>
        <b>0) â€œìë™í™”â€ëŠ” ë¸”ë¡œê·¸ìŠ¤íŒŸì—ì„œ ì™„ì„±</b>
        <div class="small">
          - ë¸”ë¡œê·¸ìŠ¤íŒŸ: ìë™ë°œí–‰/ì˜ˆì•½ë°œí–‰ âœ…<br>
          - ë„¤ì´ë²„/í‹°ìŠ¤í† ë¦¬: ìë™ë°œí–‰ì€ ì´ ì•±ì—ì„œ ë¯¸ì§€ì›(ë³µì‚¬/ìˆ˜ë™ ë°œí–‰)
        </div>
      </div>
      <div class="small mono" id="statusLine">-</div>
    </div>
  </div>

  <!-- 1) Platform -->
  <div class="box">
    <div class="row">
      <div>
        <b>1) í”Œë«í¼</b>
        <div class="small">ìë™í™”ëŠ” ë¸”ë¡œê·¸ìŠ¤íŒŸ(=Blogger OAuth)ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="platform" onchange="onPlatformChange()">
          <option value="blogspot">ğŸŸ¦ ë¸”ë¡œê·¸ìŠ¤íŒŸ(ìë™ë°œí–‰/ì˜ˆì•½ë°œí–‰)</option>
          <option value="naver">ğŸŸ© ë„¤ì´ë²„(ë³µì‚¬/ìˆ˜ë™)</option>
          <option value="tistory">ğŸŸ§ í‹°ìŠ¤í† ë¦¬(ë¯¸ì§€ì›)</option>
        </select>
        <button class="btn" onclick="loadBloggerBlogs()">ğŸ—‚ï¸ ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div class="small" style="margin-top:8px" id="blogHint">
      ë¸”ë¡œê·¸ìŠ¤íŒŸì„ ì„ íƒí•œ ë’¤ â€œë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°â€ë¥¼ ëˆ„ë¥´ë©´ blog_idê°€ í™•ë³´ë˜ì–´ ìë™ë°œí–‰ì´ ë©ë‹ˆë‹¤.
    </div>

    <div class="tabs" id="blogTabs"></div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <select id="blogSelect"></select>
      <button class="btn" onclick="setActiveFromSelect()">âœ… ì´ ë¸”ë¡œê·¸ë¡œ ì„ íƒ</button>
      <span class="small">í˜„ì¬ ì„ íƒ: <b id="activeBlogText">-</b></span>
    </div>
  </div>

  <!-- 2) Topics -->
  <div class="box">
    <div class="row">
      <div>
        <b>2) ìˆ˜ìµí˜• ì£¼ì œ</b>
        <div class="small">í•œ ë²ˆì— ì—¬ëŸ¬ ê°œ ë§Œë“¤ê³  â†’ â€œê°„ê²© ì˜ˆì•½â€ìœ¼ë¡œ ìë™ìœ¼ë¡œ ìŒ“ìŠµë‹ˆë‹¤.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="filter" placeholder="ğŸ” ê²€ìƒ‰" oninput="renderTopics()">
        <input id="topicCount" type="number" min="5" max="60" value="30" style="width:120px" />
        <button class="btn primary" onclick="makeMoneyTopics()">ğŸ’° ìˆ˜ìµí˜• ì£¼ì œ ìë™ìƒì„±</button>
        <button class="btn" onclick="makeLocalTopics()">âš¡ ë¹ ë¥¸ ìƒì„±</button>
      </div>
    </div>

    <div class="grid" id="catGrid"></div>
    <div class="list" id="topicList"></div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn primary" onclick="bulkGenerate()">âœ¨ ì„ íƒëœ ì£¼ì œë“¤ ê¸€ ìƒì„±(ëŒ€ëŸ‰)</button>
      <button class="btn good" onclick="bulkSchedule()">ğŸ—“ï¸ ê°„ê²© ì˜ˆì•½(ëŒ€ëŸ‰)</button>

      <span class="small">ì‹œì‘ì‹œê°„</span>
      <input id="bulkStart" type="datetime-local" />
      <span class="small">ê°„ê²©(ë¶„)</span>
      <input id="bulkGapMin" type="number" min="5" value="120" style="width:110px" />
      <span class="small">ëª‡ ê°œ ì˜ˆì•½?</span>
      <input id="bulkHowMany" type="number" min="1" value="10" style="width:100px" />
    </div>

    <div class="small" style="margin-top:8px">
      âœ… ì¶”ì²œ: ì‹œì‘ì‹œê°„=ì˜¤ëŠ˜ 18:00 / ê°„ê²©=120ë¶„ / 10ê°œ ì˜ˆì•½ (ë¸”ë¡œê·¸ í•˜ë‚˜ì— ì˜ˆì•½ ìŒ“ê¸°)<br>
      âœ… ì—¬ëŸ¬ ë¸”ë¡œê·¸ íƒ­ì„ ë°”ê¿”ê°€ë©° ê°ê° ì˜ˆì•½í•˜ë©´ â€œë¸”ë¡œê·¸ë³„ ì˜ˆì•½â€ì´ ë™ì‹œì— ëŒì•„ê°‘ë‹ˆë‹¤.
    </div>
  </div>

  <!-- 3) Preview -->
  <div class="box" id="previewBox" style="display:none">
    <div class="row">
      <div>
        <b>3) ìƒì„± ê²°ê³¼(ë‹¨ê±´)</b>
        <div class="small" id="previewMeta">-</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" onclick="aiGenerate()">âœ¨ ë‹¤ì‹œ ìƒì„±</button>
        <button class="btn good" onclick="publishNow()">ğŸš€ ì¦‰ì‹œë°œí–‰</button>
        <button class="btn" onclick="scheduleOne()">ğŸ—“ï¸ ì˜ˆì•½ë°œí–‰</button>
        <input id="runAtOne" type="datetime-local" />
      </div>
    </div>

    <div class="two">
      <div class="card">
        <div style="font-weight:900">ğŸ“ ë³¸ë¬¸(HTML)</div>
        <div class="pre" id="finalBody"></div>
      </div>
      <div class="card">
        <div style="font-weight:900">ğŸ–¼ï¸ ì´ë¯¸ì§€</div>
        <div class="pre" id="finalImage"></div>
        <div style="margin-top:10px">
          <img id="previewImg" alt="preview" style="width:100%;border-radius:12px;border:1px solid var(--border);display:none"/>
          <div class="small" id="imgHint" style="margin-top:8px">ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ì•„ë˜ì— ë³´ì…ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:900">ğŸ‘€ HTML ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="iframeWrap"><iframe id="previewIframe"></iframe></div>
    </div>
  </div>

  <!-- 4) Tasks -->
  <div class="box">
    <div class="row">
      <div>
        <b>4) ì˜ˆì•½ë°œí–‰ ëª©ë¡</b>
        <div class="small">â€œpendingâ€ì€ ëŒ€ê¸° / â€œrunningâ€ ì‹¤í–‰ì¤‘ / â€œokâ€ ì„±ê³µ / â€œerrâ€ ì‹¤íŒ¨</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="refreshTasks()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="taskList" class="small" style="margin-top:10px">-</div>
  </div>
</div>

<script>
/* ---- Settings ---- */
const KEY="baseone_settings_v4";
function settings(){ return JSON.parse(localStorage.getItem(KEY) || "{}"); }
function apiBase(){ return (settings().backend || location.origin).replace(/\/+$/,""); }
document.getElementById("sv").textContent = apiBase();
function esc(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}

/* ---- State ---- */
let topics=[]; // {id,title,checked,html,image_url,image_prompt}
let selectedCat="ëˆ/ì¬í…Œí¬";
let selectedTopicId="";
let bloggerBlogs=[]; // {id,name,url}
let activeBlog=null; // {id,name,url}

/* ---- Categories ---- */
const CATS=[
  {k:"ëˆ/ì¬í…Œí¬", s:"í™˜ê¸‰/ì ˆì„¸/ê³ ì •ë¹„"},
  {k:"ë³´í—˜", s:"ë³´í—˜ë£Œ ì ˆì•½/íŠ¹ì•½"},
  {k:"ëŒ€ì¶œ/ê¸ˆë¦¬", s:"ì´ì/ê°ˆì•„íƒ€ê¸°"},
  {k:"ì—°ë§ì •ì‚°", s:"ê³µì œ/í™˜ê¸‰"},
  {k:"ì •ë¶€ì§€ì›", s:"ì§€ì›ê¸ˆ/ì •ì±…"},
  {k:"ì¹´ë“œí˜œíƒ", s:"ìºì‹œë°±/í¬ì¸íŠ¸"},
  {k:"í†µì‹ ë¹„", s:"ìš”ê¸ˆì œ/í• ì¸"},
  {k:"ì „ê¸°Â·ê°€ìŠ¤", s:"ìš”ê¸ˆ ì ˆì•½"},
];
const catGrid=document.getElementById("catGrid");
CATS.forEach(obj=>{
  const d=document.createElement("div");
  d.className="cat";
  d.onclick=()=>{selectedCat=obj.k; makeLocalTopics();};
  d.innerHTML=`<b>${obj.k}</b><div class="small">${obj.s}</div>`;
  catGrid.appendChild(d);
});

/* ---- Platform ---- */
function onPlatformChange(){
  const p=document.getElementById("platform").value;
  const hint=document.getElementById("blogHint");
  if(p==="blogspot") hint.textContent="ë¸”ë¡œê·¸ìŠ¤íŒŸ ìë™í™” OK: OAuth ì—°ê²° + blog_id í™•ë³´ í•„ìš”(ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°).";
  if(p==="naver") hint.textContent="ë„¤ì´ë²„ëŠ” ìë™ë°œí–‰ ë¯¸ì§€ì›: ìƒì„±ëœ HTML ë³µì‚¬í•´ì„œ ìˆ˜ë™ìœ¼ë¡œ ì˜¬ë¦¬ì„¸ìš”.";
  if(p==="tistory") hint.textContent="í‹°ìŠ¤í† ë¦¬ Open API ì¢…ë£Œ ê³µì§€ë¡œ ìë™ë°œí–‰ ë¯¸ì§€ì›.";
  renderBlogTabs();
  loadBlogSelect();
  updateStatusLine();
}
function updateStatusLine(){
  const p=document.getElementById("platform").value;
  const a = activeBlog ? `${activeBlog.name||activeBlog.url||activeBlog.id}` : "-";
  document.getElementById("statusLine").textContent = `platform=${p} / activeBlog=${a} / topics=${topics.length}`;
}

/* ---- Blogger blogs load ---- */
async function loadBloggerBlogs(){
  const p=document.getElementById("platform").value;
  if(p!=="blogspot"){ alert("ë¸”ë¡œê·¸ìŠ¤íŒŸì—ì„œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤."); return; }

  try{
    const res=await fetch(apiBase()+"/api/blogger/blogs");
    const j=await res.json();
    if(!res.ok || !j.ok){
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì„¤ì •ì—ì„œ Blogger OAuthë¥¼ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
      return;
    }

    // settingsì— blogspot_urlsë¥¼ ì €ì¥í•´ë’€ë‹¤ë©´ ê·¸ URLë§Œ ì‚¬ìš©
    const d=settings();
    const allow=(d.blogspot_urls||[]).map(x=>x.trim()).filter(Boolean);
    bloggerBlogs = j.items || [];
    if(allow.length){
      bloggerBlogs = bloggerBlogs.filter(b => allow.includes(b.url));
    }

    if(!bloggerBlogs.length){
      alert("ë¶ˆëŸ¬ì˜¨ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. (ì„¤ì •ì˜ blogspot_urls ì œí•œì´ ê±¸ë ¸ì„ ìˆ˜ ìˆìŒ)");
      return;
    }

    // activeBlog ìë™ ì„¸íŒ… (ì²«ë²ˆì§¸)
    if(!activeBlog){
      activeBlog = bloggerBlogs[0];
      localStorage.setItem("baseone_active_blog_id", activeBlog.id);
    }

    renderBlogTabs();
    loadBlogSelect();
    updateStatusLine();
    alert("ë¸”ë¡œê·¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ!");
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}

function renderBlogTabs(){
  const box=document.getElementById("blogTabs");
  box.innerHTML="";
  const p=document.getElementById("platform").value;
  if(p!=="blogspot"){
    box.innerHTML=`<div class="small">í˜„ì¬ í”Œë«í¼ì€ íƒ­ ê³ ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  const max=10;
  const list=bloggerBlogs.slice(0,max);
  list.forEach((b,idx)=>{
    const el=document.createElement("div");
    el.className="tab"+(activeBlog && activeBlog.id===b.id ? " active":"");
    el.onclick=()=>{ activeBlog=b; localStorage.setItem("baseone_active_blog_id", b.id); loadBlogSelect(); renderBlogTabs(); updateStatusLine(); };
    el.innerHTML = `<b>ğŸŸ¦ ${idx+1}</b><small>${esc(b.name||"")} Â· ${esc(b.url||"")}</small>`;
    box.appendChild(el);
  });
}

function loadBlogSelect(){
  const sel=document.getElementById("blogSelect");
  sel.innerHTML="";
  const p=document.getElementById("platform").value;
  if(p!=="blogspot"){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="(ì´ í”Œë«í¼ì€ ìë™ë°œí–‰ ë¯¸ì§€ì›)";
    sel.appendChild(opt);
    document.getElementById("activeBlogText").textContent="-";
    return;
  }

  if(!bloggerBlogs.length){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ë¨¼ì €";
    sel.appendChild(opt);
    document.getElementById("activeBlogText").textContent="-";
    return;
  }

  bloggerBlogs.forEach(b=>{
    const opt=document.createElement("option");
    opt.value=JSON.stringify(b);
    opt.textContent=`${b.name} (${b.url})`;
    sel.appendChild(opt);
  });

  // select = activeBlog
  if(!activeBlog){
    const savedId=localStorage.getItem("baseone_active_blog_id");
    activeBlog = bloggerBlogs.find(x=>x.id===savedId) || bloggerBlogs[0];
  }
  document.getElementById("activeBlogText").textContent = activeBlog ? (activeBlog.name||activeBlog.url||activeBlog.id) : "-";

  // set selectedIndex to activeBlog
  for(let i=0;i<sel.options.length;i++){
    try{
      const b=JSON.parse(sel.options[i].value);
      if(activeBlog && b.id===activeBlog.id){ sel.selectedIndex=i; break; }
    }catch(e){}
  }
}

function setActiveFromSelect(){
  const v=document.getElementById("blogSelect").value;
  if(!v){ alert("ì„ íƒí•  ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  activeBlog=JSON.parse(v);
  localStorage.setItem("baseone_active_blog_id", activeBlog.id);
  renderBlogTabs();
  loadBlogSelect();
  updateStatusLine();
}

/* ---- Topics ---- */
function makeLocalTopics(){
  const hooks=["ì´ˆë³´ë„ ë°”ë¡œ ë˜ëŠ”","ëˆ ìƒˆëŠ” êµ¬ë© ë§‰ëŠ”","ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©","í—·ê°ˆë¦¬ê¸° ì‰¬ìš´","ì •ë¦¬ í•œ ë²ˆì—","ì‹¤ìˆ˜ ì¤„ì´ëŠ”"];
  const bases=["í™˜ê¸‰ë°›ëŠ” ë°©ë²• ì´ì •ë¦¬","ê³ ì •ë¹„ ì¤„ì´ëŠ” ìˆœì„œ","ë†“ì¹˜ë©´ ì†í•´ ë³´ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸","ì‹ ì²­ ì¡°ê±´/ëŒ€ìƒ ì •ë¦¬","ì ˆì„¸ í¬ì¸íŠ¸","ì‹¤ìˆ˜ TOP 7","ë¹„êµ ê¸°ì¤€","í•œ ë‹¬ì— ì•„ë¼ëŠ” ë°©ë²•"];
  const out=new Set();
  while(out.size<24){
    const h=hooks[Math.floor(Math.random()*hooks.length)];
    const b=bases[Math.floor(Math.random()*bases.length)];
    out.add(`${h} ${selectedCat} ${b}`);
  }
  topics=[...out].map((t,i)=>({id:`L_${Date.now()}_${i}`, title:t, checked:(i<10), html:"", image_url:"", image_prompt:""}));
  selectedTopicId=topics[0]?.id||"";
  renderTopics(); updateStatusLine();
}

async function makeMoneyTopics(){
  const d=settings();
  if(!d.gemini_key){ alert("ì„¤ì •ì—ì„œ GEMINI_API_KEY ì €ì¥ ë¨¼ì €"); return; }
  const count = Math.max(5, Math.min(60, Number(document.getElementById("topicCount").value||30)));
  try{
    const res=await fetch(apiBase()+"/api/topics/money",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({gemini_key:d.gemini_key, gemini_model:(d.gemini_model||"gemini-3-flash-preview"), count})
    });
    const j=await res.json();
    if(!res.ok || !j.ok){ alert("ì£¼ì œ ìƒì„± ì‹¤íŒ¨: "+(j.error||"")); return; }
    topics=(j.items||[]).slice(0,count).map((t,i)=>({id:`G_${Date.now()}_${i}`, title:String(t), checked:(i<10), html:"", image_url:"", image_prompt:""}));
    selectedTopicId=topics[0]?.id||"";
    renderTopics(); updateStatusLine();
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì„¤ì •ì˜ ì„œë²„ ì£¼ì†Œ í™•ì¸");
  }
}

function renderTopics(){
  const q=(document.getElementById("filter").value||"").trim().toLowerCase();
  const box=document.getElementById("topicList");
  box.innerHTML="";
  let arr=topics.slice();
  if(q) arr=arr.filter(x=>x.title.toLowerCase().includes(q));

  if(!arr.length){
    box.innerHTML=`<div class="small">ì£¼ì œ ì—†ìŒ</div>`;
    return;
  }

  arr.forEach(it=>{
    const d=document.createElement("div");
    d.className="item"+(it.id===selectedTopicId?" active":"");
    d.onclick=()=>{ selectedTopicId=it.id; showSinglePreview(it); renderTopics(); };

    d.innerHTML=`
      <div style="flex:1">
        <div class="itemTitle">
          <input type="checkbox" ${it.checked?"checked":""}
            onclick="event.stopPropagation(); toggleChecked('${it.id}')"
            style="transform:translateY(1px);margin-right:8px"/>
          ${esc(it.title)}
        </div>
        <div class="itemMeta">ğŸ·ï¸ ${esc(selectedCat)} Â· ${it.html ? "âœ… ìƒì„±ë¨":"â³ ë¯¸ìƒì„±"}</div>
      </div>
      <button class="btn" onclick="event.stopPropagation(); navigator.clipboard.writeText('${it.title.replaceAll("'","\\'")}'); alert('ë³µì‚¬ ì™„ë£Œ!');">ë³µì‚¬</button>
    `;
    box.appendChild(d);
  });
}
function toggleChecked(id){
  const t=topics.find(x=>x.id===id);
  if(!t) return;
  t.checked=!t.checked;
}

/* ---- Generate (single & bulk) ---- */
function getSelectedTitle(){ return topics.find(x=>x.id===selectedTopicId)?.title || ""; }
function getSelectedTopic(){ return topics.find(x=>x.id===selectedTopicId) || null; }

async function aiGenerate(){
  const t=getSelectedTopic();
  if(!t){ alert("ì£¼ì œ ì„ íƒ"); return; }
  const ok = await generateOne(t);
  if(ok) showSinglePreview(t);
}

async function generateOne(topicObj){
  const d=settings();
  if(!d.gemini_key){ alert("ì„¤ì •ì—ì„œ GEMINI_API_KEY ì €ì¥ ë¨¼ì €"); return false; }

  const payload={
    topic: topicObj.title,
    category: selectedCat,
    gemini_key: d.gemini_key,
    gemini_model: (d.gemini_model||"gemini-3-flash-preview"),
    img_provider: (d.img_provider||"pexels"),
    pexels_key: (d.pexels_key||"")
  };

  try{
    const res=await fetch(apiBase()+"/api/generate",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const j=await res.json();
    if(!res.ok || !j.ok){
      alert("ìƒì„± ì‹¤íŒ¨: "+(j.error||""));
      return false;
    }
    topicObj.html = j.html || "";
    topicObj.image_url = j.image_url || "";
    topicObj.image_prompt = j.image_prompt || "";
    renderTopics();
    return true;
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
    return false;
  }
}

async function bulkGenerate(){
  const list = topics.filter(x=>x.checked);
  if(!list.length){ alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  // ë¹ ë¥´ê²Œ: ì²´í¬ëœ ê²ƒ ì¤‘, ì•„ì§ html ì—†ëŠ” ê²ƒë§Œ ìƒì„±
  const targets = list.filter(x=>!x.html);
  if(!targets.length){ alert("ì²´í¬ëœ ì£¼ì œë“¤ì€ ì´ë¯¸ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."); return; }

  if(!confirm(`ì²´í¬ëœ ${list.length}ê°œ ì¤‘ ë¯¸ìƒì„± ${targets.length}ê°œë¥¼ ìƒì„±í• ê¹Œìš”?`)) return;

  for(let i=0;i<targets.length;i++){
    const t=targets[i];
    document.getElementById("statusLine").textContent = `ìƒì„±ì¤‘ ${i+1}/${targets.length} ... (${t.title})`;
    const ok = await generateOne(t);
    if(!ok) break;
  }
  updateStatusLine();
  alert("ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ(ë˜ëŠ” ì¤‘ë‹¨).");
}

/* ---- Preview UI ---- */
function showSinglePreview(t){
  if(!t) return;
  if(!t.html){
    document.getElementById("previewBox").style.display="none";
    return;
  }

  document.getElementById("finalBody").textContent = t.html;
  document.getElementById("finalImage").textContent =
    (t.image_url ? (t.image_prompt+"\n"+t.image_url) : (t.image_prompt||""));

  document.getElementById("previewMeta").textContent = `ğŸ§  ${t.title} / ğŸ·ï¸ ${selectedCat}`;

  document.getElementById("previewIframe").srcdoc =
    `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style>
    </head><body>${t.html}</body></html>`;

  const img=document.getElementById("previewImg");
  const hint=document.getElementById("imgHint");
  if(t.image_url){
    img.src=t.image_url; img.style.display="block"; hint.style.display="none";
  }else{
    img.style.display="none"; hint.style.display="block";
  }
  document.getElementById("previewBox").style.display="block";
}

/* ---- Publish / Schedule ---- */
function utcIsoFromLocalDatetime(localVal){
  const dt = new Date(localVal);
  return dt.toISOString();
}

async function addTask(payload){
  const res=await fetch(apiBase()+"/api/tasks/add",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  const j=await res.json();
  if(!res.ok || !j.ok) throw new Error(j.error||"task add failed");
}

async function publishNow(){
  const p=document.getElementById("platform").value;
  const t=getSelectedTopic();
  if(!t || !t.html){ alert("ë¨¼ì € ê¸€ ìƒì„±"); return; }

  if(p!=="blogspot"){
    alert("ìë™ë°œí–‰ì€ ë¸”ë¡œê·¸ìŠ¤íŒŸë§Œ ì§€ì›í•©ë‹ˆë‹¤. (ë„¤ì´ë²„/í‹°ìŠ¤í† ë¦¬: ë³µì‚¬/ìˆ˜ë™)");
    return;
  }
  if(!activeBlog || !activeBlog.id){ alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„, íƒ­ì—ì„œ ë¸”ë¡œê·¸ ì„ íƒ"); return; }

  await addTask({platform:"blogspot", blog_id:activeBlog.id, blog_url:activeBlog.url||"", title:t.title, html:t.html, run_at:new Date().toISOString()});
  alert("ì¦‰ì‹œë°œí–‰ íì— ë„£ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì˜¬ë¼ê°‘ë‹ˆë‹¤.");
  refreshTasks();
}

async function scheduleOne(){
  const p=document.getElementById("platform").value;
  const t=getSelectedTopic();
  const localVal=(document.getElementById("runAtOne").value||"").trim();
  if(!localVal){ alert("ì˜ˆì•½ì‹œê°„ ì„ íƒ"); return; }
  if(!t || !t.html){ alert("ë¨¼ì € ê¸€ ìƒì„±"); return; }

  if(p!=="blogspot"){
    alert("ìë™ ì˜ˆì•½ì€ ë¸”ë¡œê·¸ìŠ¤íŒŸë§Œ ì§€ì›í•©ë‹ˆë‹¤.");
    return;
  }
  if(!activeBlog || !activeBlog.id){ alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„, íƒ­ì—ì„œ ë¸”ë¡œê·¸ ì„ íƒ"); return; }

  const run_at = utcIsoFromLocalDatetime(localVal);
  await addTask({platform:"blogspot", blog_id:activeBlog.id, blog_url:activeBlog.url||"", title:t.title, html:t.html, run_at});
  alert("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ!");
  refreshTasks();
}

async function bulkSchedule(){
  const p=document.getElementById("platform").value;
  if(p!=="blogspot"){
    alert("ëŒ€ëŸ‰ ì˜ˆì•½ì€ ë¸”ë¡œê·¸ìŠ¤íŒŸë§Œ ì§€ì›í•©ë‹ˆë‹¤.");
    return;
  }
  if(!activeBlog || !activeBlog.id){ alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„, íƒ­ì—ì„œ ë¸”ë¡œê·¸ ì„ íƒ"); return; }

  const list = topics.filter(x=>x.checked);
  if(!list.length){ alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  const howMany = Math.max(1, Number(document.getElementById("bulkHowMany").value||1));
  const gapMin  = Math.max(5, Number(document.getElementById("bulkGapMin").value||120));
  const startVal = (document.getElementById("bulkStart").value||"").trim();

  if(!startVal){
    alert("ì‹œì‘ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const selected = list.slice(0, howMany);

  // ì˜ˆì•½í•˜ë ¤ë©´ htmlì´ í•„ìš”: ì—†ìœ¼ë©´ ìë™ ìƒì„±ë¶€í„°
  const needGen = selected.filter(x=>!x.html);
  if(needGen.length){
    if(confirm(`ì˜ˆì•½ ëŒ€ìƒ ${selected.length}ê°œ ì¤‘ ${needGen.length}ê°œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ì–´ìš”. ë¨¼ì € ìƒì„±í• ê¹Œìš”?`)){
      for(let i=0;i<needGen.length;i++){
        const t=needGen[i];
        document.getElementById("statusLine").textContent = `ì˜ˆì•½ ì „ ìƒì„±ì¤‘ ${i+1}/${needGen.length} ... (${t.title})`;
        const ok = await generateOne(t);
        if(!ok) return;
      }
    }else{
      alert("ìƒì„±ë˜ì§€ ì•Šì€ ê¸€ì´ ìˆì–´ ì˜ˆì•½ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.");
      return;
    }
  }

  if(!confirm(`"${activeBlog.name}"ì— ${selected.length}ê°œë¥¼ ${gapMin}ë¶„ ê°„ê²©ìœ¼ë¡œ ì˜ˆì•½í• ê¹Œìš”?`)) return;

  const start = new Date(startVal);
  for(let i=0;i<selected.length;i++){
    const t=selected[i];
    const run = new Date(start.getTime() + i*gapMin*60*1000);
    await addTask({platform:"blogspot", blog_id:activeBlog.id, blog_url:activeBlog.url||"", title:t.title, html:t.html, run_at:run.toISOString()});
  }

  updateStatusLine();
  alert("ëŒ€ëŸ‰ ì˜ˆì•½ ì €ì¥ ì™„ë£Œ!");
  refreshTasks();
}

/* ---- Tasks UI ---- */
async function refreshTasks(){
  const box=document.getElementById("taskList");
  box.textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    const res=await fetch(apiBase()+"/api/tasks/list");
    const j=await res.json();
    if(!res.ok || !j.ok){ box.textContent="ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"; return; }
    const items=j.items||[];
    if(!items.length){ box.textContent="ì˜ˆì•½ ì—†ìŒ"; return; }

    box.innerHTML = items.slice(0,80).map(it=>{
      const st=it.status;
      const badge = st==="ok"?"âœ…":st==="err"?"âŒ":st==="running"?"ğŸŸ¦":st==="canceled"?"ğŸš«":"â³";
      const url = it.result_url ? `<div><a href="${it.result_url}" target="_blank">ğŸ”— ê²°ê³¼ ë§í¬</a></div>` : "";
      const err = it.error ? `<div style="color:#ffb4b4">ì—ëŸ¬: ${esc(it.error)}</div>` : "";
      const cancelBtn = (st==="pending") ? `<button class="btn danger" onclick="cancelTask(${it.id})">ì·¨ì†Œ</button>` : "";
      return `
        <div style="padding:10px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.06);margin-top:8px">
          <div style="font-weight:900">${badge} [#${it.id}] ${esc(it.title)}</div>
          <div class="small">í”Œë«í¼: ${esc(it.platform)} / blog_id: ${esc(it.blog_id||"-")} / run_at(UTC): ${esc(it.run_at)}</div>
          ${url}
          ${err}
          <div style="margin-top:6px">${cancelBtn}</div>
        </div>
      `;
    }).join("");
  }catch(e){
    box.textContent="ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
  }
}

async function cancelTask(id){
  if(!confirm("ì´ ì˜ˆì•½ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
  await fetch(apiBase()+`/api/tasks/cancel/${id}`, {method:"POST"});
  refreshTasks();
}
<!-- âœ… (ì„ íƒ) ì˜ˆì•½ ê°„ê²© ì…ë ¥ UIê°€ ì—†ìœ¼ë©´ ì•„ë˜ input í•˜ë‚˜ ì¶”ê°€í•´ë„ ë¨ -->
<!-- <input id="intervalMin" value="60" /> -->

<script>
/* ===============================
   âœ… 10Ã—10 ìë™ì˜ˆì•½ + ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° + OAuth
   (ê¸°ì¡´ <script> ë§¨ ì•„ë˜ì— ì¶”ê°€)
   =============================== */

async function oauthConnect(){
  window.open(API_BASE + "/oauth/start", "_blank");
}

async function loadBlogsFromServer(){
  try{
    const res = await fetch(API_BASE + "/api/blogger/blogs");
    const j = await res.json();

    if(!res.ok || !j.ok){
      alert("ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (j.error || "unknown") + "\në¨¼ì € OAuth ì—°ê²°í•˜ì„¸ìš”.");
      return;
    }

    // v3ì— blogspot ëª©ë¡ ì €ì¥ (ìµœëŒ€ 10ê°œ)
    const v3 = JSON.parse(localStorage.getItem("baseone_settings_v3") || "{}");
    v3.blogspot_blogs = (j.items || []).slice(0, 10).map(b=>({
      type: "blogspot",
      blog_id: b.id,
      name: b.name,
      url: b.url
    }));
    localStorage.setItem("baseone_settings_v3", JSON.stringify(v3));

    alert(`ë¸”ë¡œê·¸ìŠ¤íŒŸ ${v3.blogspot_blogs.length}ê°œ ë¶ˆëŸ¬ì˜´`);
    loadBlogsToSelect();
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨: " + e);
  }
}

async function distributeSchedule(){
  const v3 = JSON.parse(localStorage.getItem("baseone_settings_v3") || "{}");
  const blogs = (v3.blogspot_blogs || []).slice(0, 10);

  if(!blogs.length){
    alert("ë¨¼ì € ğŸ“¥ ë‚´ë¸”ë¡œê·¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë¸”ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
    return;
  }
  if(!topics.length){
    alert("ë¨¼ì € ì¹´í…Œê³ ë¦¬ë¥¼ ëˆŒëŸ¬ì„œ ì£¼ì œë¥¼ ìƒì„±í•˜ì„¸ìš”.");
    return;
  }

  // ê° ë¸”ë¡œê·¸ë‹¹ 10ê°œì”© = ìµœëŒ€ 100ê°œ ì‚¬ìš©
  const titles = topics.map(x=>x.title).slice(0, 100);

  // ì˜ˆì•½ ê°„ê²©(ë¶„) - ì—†ìœ¼ë©´ ê¸°ë³¸ 60ë¶„
  let interval = 60;
  const el = document.getElementById("intervalMin");
  if(el && el.value) interval = Math.max(1, Number(el.value) || 60);

  const payload = {
    blogs: blogs.map(b=>({
      blog_type: b.type,
      blog_id: b.blog_id,
      blog_url: b.url,
      blog_name: b.name
    })),
    titles,
    category: selectedCat || "ëˆ/ì¬í…Œí¬",
    per_blog: 10,
    interval_minutes: interval,
    start_time: "NOW"
  };

  try{
    const res = await fetch(API_BASE + "/api/schedule/distribute",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();

    if(!res.ok || !j.ok){
      alert("ìë™ì˜ˆì•½ ì‹¤íŒ¨: " + (j.error || "unknown"));
      return;
    }

    alert(`ìë™ì˜ˆì•½ ì™„ë£Œ! ì´ ${j.created}ê°œ (ë¸”ë¡œê·¸ë‹¹ 10ê°œ)`);
  }catch(e){
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }
}
</script>

/* ---- init ---- */
onPlatformChange();
makeLocalTopics();
loadBlogsToSelect();
renderTopics();
<button class="btn" onclick="oauthConnect()">ğŸ” OAuth</button>
<button class="btn" onclick="loadBlogsFromServer()">ğŸ“¥ ë‚´ë¸”ë¡œê·¸</button>
<button class="btn good" onclick="distributeSchedule()">ğŸ“… 10Ã—10 ìë™ì˜ˆì•½</button>
<select id="intervalMin" style="min-width:120px">
  <option value="60">60ë¶„</option>
  <option value="120">120ë¶„</option>
  <option value="180">180ë¶„</option>
</select>
<style>
  /* âœ… ë””ë²„ê·¸ ë°”/í…ìŠ¤íŠ¸ ìˆ¨ê¹€ (init... ê°™ì€ ê±° ë‚˜ì˜¤ëŠ” ê²½ìš°) */
  #debug, .debug, #statusBar, #devBar { display:none !important; }
</style>


