<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BaseOne - ìˆ˜ìµí˜• ê¸€ ìë™í™”</title>
<style>
body{margin:0;font-family:"Noto Sans KR",system-ui;background:#0f1630;color:#fff}
.wrap{max-width:900px;margin:0 auto;padding:16px}
.box{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;margin:12px 0}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
button,select,input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff}
button{cursor:pointer;font-weight:700}
.primary{background:linear-gradient(135deg,#7aa7ff,#38e1c1);border:none}
.list{max-height:280px;overflow:auto;margin-top:10px}
.item{padding:8px;border:1px solid rgba(255,255,255,.15);border-radius:10px;margin-bottom:6px;cursor:pointer}
.item.active{border-color:#7aa7ff;background:rgba(122,167,255,.15)}
.small{font-size:12px;opacity:.8}
textarea{width:100%;min-height:180px}
iframe{width:100%;height:300px;border:0}
</style>
</head>
<body>
<div class="wrap">

<h2>BaseOne â€“ ìˆ˜ìµí˜• ìë™ ê¸€ì“°ê¸°</h2>

<div class="box">
  <b>1) ë¸”ë¡œê·¸ ì„ íƒ</b><br>
  <select id="blogSelect"></select>
  <div class="small">í˜„ì¬: <span id="blogNow">-</span></div>
</div>

<div class="box">
  <b>2) ìˆ˜ìµí˜• ì£¼ì œ ì„ íƒ</b>
  <div style="margin-top:6px">
    <button onclick="makeTopics('ëˆ/ì¬í…Œí¬')">ëˆ/ì¬í…Œí¬</button>
    <button onclick="makeTopics('ìƒí™œë¹„')">ìƒí™œë¹„</button>
    <button onclick="makeTopics('IT')">IT</button>
    <button onclick="makeTopics('ê±´ê°•')">ê±´ê°•</button>
  </div>
  <div class="list" id="topicList"></div>
  <button class="primary" onclick="aiGenerate()">âœ¨ AI ê¸€ ìƒì„±</button>
</div>

<div class="box" id="previewBox" style="display:none">
  <b>3) ìƒì„± ê²°ê³¼</b>
  <div class="small" id="meta">-</div>

  <h4>ë³¸ë¬¸</h4>
  <textarea id="finalBody"></textarea>

  <h4>ì´ë¯¸ì§€</h4>
  <input id="finalImage">
  <img id="previewImg" style="width:100%;margin-top:6px;display:none">

  <h4>HTML ë¯¸ë¦¬ë³´ê¸°</h4>
  <iframe id="previewIframe"></iframe>

  <button class="primary" onclick="publishNow()">ğŸš€ ì¦‰ì‹œ ë°œí–‰</button>
</div>

</div>

<script>
/* ---------- API BASE ---------- */
function getApiBase(){
  const s=JSON.parse(localStorage.getItem("baseone_settings_v3")||"{}");
  return (s.backend||"http://127.0.0.1:5000").replace(/\/+$/,"");
}
const API_BASE=getApiBase();

/* ---------- BLOG SELECT ---------- */
function loadBlogs(){
  const sel=document.getElementById("blogSelect");
  const now=document.getElementById("blogNow");
  sel.innerHTML="";
  const v3=JSON.parse(localStorage.getItem("baseone_settings_v3")||"{}");
  const blogs=(v3.blogspot||[]).map(u=>({type:"blogspot",url:u}));
  if(!blogs.length){
    sel.innerHTML=`<option>ì„¤ì •ì—ì„œ ë¸”ë¡œê·¸ ë¨¼ì € ì¶”ê°€</option>`;
    return;
  }
  blogs.forEach((b,i)=>{
    const o=document.createElement("option");
    o.value=JSON.stringify(b);
    o.textContent=`ë¸”ë¡œê·¸ ${i+1} - ${b.url}`;
    sel.appendChild(o);
  });
  updateBlog();
}
function updateBlog(){
  const v=document.getElementById("blogSelect").value;
  try{
    const o=JSON.parse(v);
    document.getElementById("blogNow").textContent=o.type+" / "+o.url;
  }catch(e){
    document.getElementById("blogNow").textContent="-";
  }
}
document.getElementById("blogSelect").onchange=updateBlog;
function getBlog(){
  try{return JSON.parse(document.getElementById("blogSelect").value)}catch(e){return null}
}

/* ---------- TOPICS ---------- */
let topics=[],selectedId="",selectedCat="";
function buildIdeas(cat){
  const base=[
    "ì›” 10ë§Œì› ì•„ë¼ëŠ” ë°©ë²•",
    "ê³ ì •ë¹„ ì¤„ì´ëŠ” ìˆœì„œ",
    "ì¹´ë“œ í˜œíƒ 200% ì“°ê¸°",
    "ì „ê¸°ìš”ê¸ˆ ì ˆì•½ë²•",
    "ë³´í—˜ë£Œ ì¤„ì´ê¸°"
  ];
  return base.map(b=>`${cat} - ${b}`);
}
function makeTopics(cat){
  selectedCat=cat;
  const arr=buildIdeas(cat);
  topics=arr.map((t,i)=>({id:"t"+i,title:t}));
  selectedId=topics[0]?.id||"";
  renderTopics();
}
function renderTopics(){
  const box=document.getElementById("topicList");
  box.innerHTML="";
  topics.forEach(t=>{
    const d=document.createElement("div");
    d.className="item"+(t.id===selectedId?" active":"");
    d.textContent=t.title;
    d.onclick=()=>{selectedId=t.id;renderTopics()};
    box.appendChild(d);
  });
}
function getTitle(){
  return topics.find(x=>x.id===selectedId)?.title||"";
}

/* ---------- AI GENERATE ---------- */
async function aiGenerate(){
  const blog=getBlog();
  const title=getTitle();
  if(!blog){alert("ë¸”ë¡œê·¸ ì„ íƒ");return;}
  if(!title){alert("ì£¼ì œ ì„ íƒ");return;}

  const s=JSON.parse(localStorage.getItem("baseone_settings_v3")||"{}");
  const payload={
    topic:title,
    category:selectedCat,
    img_provider:"pexels",
    pexels_key:s.pexels_key||""
  };

  const res=await fetch(API_BASE+"/api/generate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  const data=await res.json();

  document.getElementById("previewBox").style.display="block";
  document.getElementById("finalBody").value=data.body_prompt||"";
  document.getElementById("finalImage").value=data.image_url||"";
  document.getElementById("meta").textContent=data.topic+" / "+data.category;

  const iframe=document.getElementById("previewIframe");
  iframe.srcdoc=`<html><body>${data.body_prompt||""}</body></html>`;

  const img=document.getElementById("previewImg");
  if(data.image_url){
    img.src=data.image_url;
    img.style.display="block";
  }else img.style.display="none";
}

/* ---------- PUBLISH ---------- */
async function publishNow(){
  const blog=getBlog();
  const title=getTitle();
  const html=document.getElementById("finalBody").value;
  if(!blog||!title||!html){alert("ì •ë³´ ë¶€ì¡±");return;}

  const payload={
    blog_id: blog.blog_id,
    title: title,
    html: html
  };

  const res=await fetch(API_BASE+"/api/blogger/post",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  const j=await res.json();
  if(!res.ok){alert("ì‹¤íŒ¨: "+(j.error||""));return;}
  alert("ë°œí–‰ ì™„ë£Œ!\n"+j.url);
}

/* ---------- INIT ---------- */
loadBlogs();
</script>
</body>
</html>
