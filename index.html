<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BaseOne</title>
  <style>
    :root{
      --bg:#0f1630;
      --panel:rgba(255,255,255,.07);
      --panel2:rgba(255,255,255,.10);
      --text:#f8faff;
      --muted:rgba(248,250,255,.74);
      --border:rgba(255,255,255,.14);
      --primary:#7aa7ff;
      --good:#38e1c1;
      --danger:#ff7b7b;
      --shadow:0 12px 28px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(1100px 650px at 18% 12%, rgba(122,167,255,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(56,225,193,.14), transparent 50%),
        linear-gradient(180deg,var(--bg),#0a1022);
      color:var(--text);
      font-size:13px;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1120px;margin:0 auto;padding:14px}

    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 2px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:36px;height:36px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--good));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;box-shadow:var(--shadow);
      user-select:none;
    }
    .title{font-size:18px;font-weight:900;line-height:1}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}

    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      color:var(--muted);font-size:12px;
    }

    .box{
      background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      padding:12px;border-radius:18px;margin:10px 0;
      box-shadow:var(--shadow);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}

    input,select{
      padding:9px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);outline:none;font-size:12.5px
    }
    select{min-width:320px;max-width:100%}

    .btn{
      padding:9px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:900;font-size:12px;
      transition:transform .06s ease, filter .15s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#2f6bff);border:none;color:#fff}
    .btn.good{background:linear-gradient(135deg,var(--good),#1fb6ff);border:none;color:#fff}
    .btn.danger{background:rgba(255,107,107,.10);border:1px solid rgba(255,107,107,.35);color:var(--danger)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}

    .cat{
      background:linear-gradient(135deg, rgba(255,255,255,.11), rgba(255,255,255,.05));
      border:1px solid var(--border);
      padding:12px;border-radius:16px;cursor:pointer;
      transition:transform .06s ease, border-color .15s ease, filter .15s ease;
      position:relative;overflow:hidden;
    }
    .cat:before{
      content:"";
      position:absolute; inset:-1px;
      background:radial-gradient(700px 240px at 20% 20%, rgba(122,167,255,.22), transparent 55%);
      opacity:.7; pointer-events:none;
    }
    .cat:hover{border-color:rgba(122,167,255,.55);filter:brightness(1.03)}
    .cat:active{transform:translateY(1px)}
    .cat b,.cat .small{position:relative;z-index:1}

    .layout{display:grid;grid-template-columns:1.1fr .9fr;gap:10px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}

    .list{max-height:420px;overflow:auto;margin-top:10px;padding-right:6px}
    .item{
      background:rgba(255,255,255,.07);
      border:1px solid var(--border);
      padding:10px;border-radius:16px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      margin-bottom:8px;cursor:pointer;
    }
    .item:hover{filter:brightness(1.03)}
    .item.selected{
      border-color:rgba(122,167,255,.9);
      box-shadow:0 0 0 2px rgba(122,167,255,.18);
      background:linear-gradient(135deg,rgba(122,167,255,.16),rgba(56,225,193,.10));
    }
    .item.checked{
      border-color:rgba(56,225,193,.35);
      background:linear-gradient(135deg,rgba(56,225,193,.10),rgba(255,255,255,.05));
    }
    .itemTitle{font-weight:900}
    .itemMeta{font-size:11.5px;color:var(--muted);margin-top:4px}
    .rightBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.10);
      font-weight:900;
    }

    .card{
      background:rgba(255,255,255,.07);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
    }
    .pre{
      margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:10px;
      min-height:180px;white-space:pre-wrap;overflow:auto;background:rgba(0,0,0,.10)
    }
    .iframeWrap{margin-top:8px;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:320px}
    iframe{width:100%;height:320px;border:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);cursor:pointer;
      display:flex;align-items:center;gap:8px;
      max-width:100%;
    }
    .tab small{opacity:.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:520px}
    .tab.active{border-color:rgba(122,167,255,.85);box-shadow:0 0 0 2px rgba(122,167,255,.18)}

    /* ì§„í–‰ìƒí™© ë¡œê·¸ ë°•ìŠ¤ */
    .logBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
      min-height:92px;
      max-height:160px;
      overflow:auto;
      font-size:12px;
      line-height:1.55;
    }
    .logLine{color:rgba(248,250,255,.86)}
    .logLine.good{color:rgba(56,225,193,.95)}
    .logLine.bad{color:rgba(255,123,123,.95)}
    .logLine.dim{color:rgba(248,250,255,.60)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BaseOne</div>
        <div class="subtitle">ì£¼ì œ â†’ ê¸€ ìƒì„±(Gemini/GPT) â†’ ì´ë¯¸ì§€(Pexels) â†’ ì¦‰ì‹œë°œí–‰/ì˜ˆì•½ë°œí–‰(ë¸”ë¡œê·¸ìŠ¤íŒŸ)</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill">ğŸ›°ï¸ ì„œë²„ <b id="sv">-</b></span>
      <span class="pill" id="oauthPill">ğŸ” OAuth <b id="oauth">-</b></span>
      <a href="/settings"><button class="btn">âš™ï¸ ì„¤ì •</button></a>
      <button class="btn" onclick="refreshTasks()">ğŸ“‹ ì˜ˆì•½ëª©ë¡</button>
    </div>
  </div>

  <!-- 1) OAuth & Blogs -->
  <div class="box">
    <div class="row">
      <div>
        <b>1) OAuth + ë¸”ë¡œê·¸ ì„ íƒ</b>
        <div class="small">OAuth ì—°ê²° â†’ ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° â†’ ë¸”ë¡œê·¸ ì„ íƒ(í˜„ì¬ ë°œí–‰ ëŒ€ìƒ)</div>
      </div>
      <div class="small mono" id="statusLine">-</div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <select id="blogSelect"></select>
      <button class="btn good" onclick="setActiveFromSelect()">âœ… ì„ íƒ</button>
      <button class="btn" onclick="oauthConnect()">ğŸ” OAuth ì—°ê²°</button>
      <button class="btn primary" onclick="loadBlogs()">ğŸ“¥ ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="small">í˜„ì¬ ë¸”ë¡œê·¸: <b id="activeBlogText">-</b></span>
    </div>

    <div class="tabs" id="blogTabs"></div>
  </div>

  <div class="layout">

    <!-- LEFT: Topics -->
    <div class="box">
      <div class="row">
        <div>
          <b>2) ì£¼ì œ ë§Œë“¤ê¸°</b>
          <div class="small">ì¹´í…Œê³ ë¦¬ í´ë¦­ â†’ ì£¼ì œ ìƒì„± / ì²´í¬(ì—¬ëŸ¬ê°œ) ê°€ëŠ¥ / â€œì„ íƒ(í˜„ì¬ ê¸€)â€ì€ 1ê°œ</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="filter" placeholder="ğŸ” ê²€ìƒ‰" oninput="renderTopics()">
          <input id="topicCount" type="number" min="5" max="60" value="30" style="width:110px" />
          <button class="btn" onclick="makeLocalTopics()">âš¡ ë¡œì»¬</button>
          <button class="btn primary" onclick="makeMoneyTopics()">ğŸ¤– AI</button>
        </div>
      </div>

      <!-- í‚¤ì›Œë“œ ìë™ìˆ˜ì§‘ -> ì£¼ì œí™” -->
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="kwSeed" placeholder="ğŸ“Œ í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ì •ë¶€ì§€ì›ê¸ˆ, ì¹´ë“œ ì¶”ì²œ)" style="flex:1;min-width:240px"/>
        <input id="kwCount" type="number" min="5" max="60" value="30" style="width:110px"/>
        <button class="btn primary" onclick="keywordToTopics()">ğŸ“Œ í‚¤ì›Œë“œâ†’ì£¼ì œ</button>
      </div>

      <div class="grid" id="catGrid"></div>

      <div class="list" id="topicList"></div>

      <!-- ì•¡ì…˜ë°”(ìµœì†Œ) -->
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div class="small">
          ğŸ¯ ì„ íƒ: <span class="chip" id="selChip">ì—†ìŒ</span>
          <span class="small" style="margin-left:8px">âœ… ì²´í¬: <b id="checkedCount">0</b>ê°œ</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button class="btn primary" onclick="generateSelected()">âœ¨ ì„ íƒ ê¸€ ìƒì„±</button>
          <button class="btn good" onclick="publishSelected()">ğŸš€ ì„ íƒ ê¸€ ë°œí–‰</button>
          <button class="btn" onclick="generateChecked()">âœ¨ ì²´í¬ ê¸€ ìƒì„±</button>
          <button class="btn" onclick="scheduleChecked()">ğŸ—“ï¸ ì²´í¬ ì˜ˆì•½</button>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="small">ì˜ˆì•½ ì‹œì‘</span>
        <input id="scheduleAt" type="datetime-local"/>
        <span class="small">ê°„ê²©(ë¶„)</span>
        <input id="gapMin" type="number" min="5" value="120" style="width:110px"/>
      </div>

      <!-- ì§„í–‰ìƒí™© ë¡œê·¸ -->
      <div class="logBox" id="logBox"></div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="box">
      <div class="row">
        <div>
          <b>3) ë¯¸ë¦¬ë³´ê¸°</b>
          <div class="small" id="previewMeta">ì•„ì§ ìƒì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="copyHtml()">ğŸ“‹ HTML ë³µì‚¬</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div style="font-weight:900">ğŸ“ ë³¸ë¬¸(HTML)</div>
        <div class="pre" id="finalBody">(ë¹„ì–´ìˆìŒ)</div>
      </div>

      <div class="card" style="margin-top:10px">
        <div style="font-weight:900">ğŸ–¼ï¸ ì´ë¯¸ì§€</div>
        <div class="pre" id="finalImage">(ë¹„ì–´ìˆìŒ)</div>
        <div style="margin-top:10px">
          <img id="previewImg" alt="preview" style="width:100%;border-radius:12px;border:1px solid var(--border);display:none"/>
          <div class="small" id="imgHint" style="margin-top:8px">ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div style="font-weight:900">ğŸ‘€ ë Œë” ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="iframeWrap"><iframe id="previewIframe"></iframe></div>
      </div>
    </div>

  </div>

  <!-- Tasks -->
  <div class="box">
    <div class="row">
      <div>
        <b>4) ì˜ˆì•½ë°œí–‰ ëª©ë¡</b>
        <div class="small">pending ëŒ€ê¸° / running ì‹¤í–‰ / ok ì„±ê³µ / err ì‹¤íŒ¨</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="refreshTasks()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="taskList" class="small" style="margin-top:10px">-</div>
  </div>

</div>

<script>
/* ==========================
   BaseOne - Simplified index.html
   ========================== */

/* ---- Settings ---- */
const KEY="baseone_settings_v4";
function settings(){ return JSON.parse(localStorage.getItem(KEY) || "{}"); }
function apiBase(){ return (settings().backend || location.origin).replace(/\/+$/,""); }
document.getElementById("sv").textContent = apiBase();

function esc(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escAttr(s){
  return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ---- State ---- */
let topics=[]; // {id,title,checked,html,image_url,image_prompt}
let selectedCat="ëˆ/ì¬í…Œí¬";
let selectedTopicId="";
let bloggerBlogs=[]; // {id,name,url}
let activeBlog=null; // {id,name,url}
let busy=false;

/* ---- Log ---- */
function log(msg, type="dim"){
  const box=document.getElementById("logBox");
  const t=new Date();
  const hh=String(t.getHours()).padStart(2,"0");
  const mm=String(t.getMinutes()).padStart(2,"0");
  const ss=String(t.getSeconds()).padStart(2,"0");
  const div=document.createElement("div");
  div.className="logLine "+type;
  div.textContent=`[${hh}:${mm}:${ss}] ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function setBusy(v){
  busy=!!v;
  document.querySelectorAll("button").forEach(b=>{
    if(b.textContent.includes("OAuth")) return; // OAuthëŠ” ìƒˆì°½ì´ë¼ ë†”ë‘ 
    b.disabled = busy;
    b.style.opacity = busy ? ".65" : "1";
    b.style.cursor = busy ? "not-allowed" : "pointer";
  });
}

/* ---- OAuth status ---- */
async function refreshOAuth(){
  try{
    const res = await fetch(apiBase()+"/api/oauth/status");
    const j = await res.json();
    const ok = !!(res.ok && j.ok && j.connected);
    document.getElementById("oauth").textContent = ok ? "connected" : "not connected";
    document.getElementById("oauthPill").style.borderColor = ok ? "rgba(56,225,193,.55)" : "rgba(255,123,123,.45)";
  }catch(e){
    document.getElementById("oauth").textContent = "unknown";
  }
}
function oauthConnect(){
  window.open(apiBase()+"/oauth/start", "_blank");
  log("OAuth ì°½ì„ ì—´ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ëŒì•„ì™€ì„œ 'ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.", "dim");
}

/* ---- Categories ---- */
const CATS=[
  {k:"ëˆ/ì¬í…Œí¬", e:"ğŸ’°", s:"í™˜ê¸‰/ì ˆì„¸/ê³ ì •ë¹„"},
  {k:"ì •ë¶€ì§€ì›", e:"ğŸ›ï¸", s:"ì§€ì›ê¸ˆ/ì •ì±…/ì‹ ì²­"},
  {k:"ì—°ë§ì •ì‚°", e:"ğŸ§¾", s:"ê³µì œ/í™˜ê¸‰"},
  {k:"ì¹´ë“œí˜œíƒ", e:"ğŸ’³", s:"ìºì‹œë°±/í¬ì¸íŠ¸"},
  {k:"í†µì‹ ë¹„", e:"ğŸ“¶", s:"ìš”ê¸ˆì œ/í• ì¸"},
  {k:"ëŒ€ì¶œ/ê¸ˆë¦¬", e:"ğŸ¦", s:"ê°ˆì•„íƒ€ê¸°/ì´ì"},
  {k:"ë³´í—˜", e:"ğŸ›¡ï¸", s:"íŠ¹ì•½/ë³´í—˜ë£Œ"},
  {k:"ìƒí™œë¹„ì ˆì•½", e:"ğŸ§ ", s:"ì „ê¸°/ê°€ìŠ¤/êµ¬ë…"},
];
const catGrid=document.getElementById("catGrid");
CATS.forEach(obj=>{
  const d=document.createElement("div");
  d.className="cat";
  d.onclick=()=>{selectedCat=obj.k; makeLocalTopics(); log(`ì¹´í…Œê³ ë¦¬ ë³€ê²½: ${obj.k}`, "dim");};
  d.innerHTML=`<b>${esc(obj.e)} ${esc(obj.k)}</b><div class="small">${esc(obj.s)}</div>`;
  catGrid.appendChild(d);
});

/* ---- Helper ---- */
function updateStatusLine(){
  const a = activeBlog ? `${activeBlog.name||activeBlog.url||activeBlog.id}` : "-";
  const checked = topics.filter(x=>x.checked).length;
  document.getElementById("statusLine").textContent = `activeBlog=${a} / topics=${topics.length} / checked=${checked} / cat=${selectedCat}`;
  document.getElementById("checkedCount").textContent = String(checked);
  const sel = getSelectedTopic();
  document.getElementById("selChip").textContent = sel ? sel.title : "ì—†ìŒ";
}

/* ---- URL normalize for allowlist ---- */
function normUrl(u){
  const raw = String(u||"").trim();
  if(!raw) return "";
  try{
    const url = new URL(raw);
    const host = (url.hostname||"").toLowerCase().replace(/^www\./,"");
    const path = (url.pathname||"/").replace(/\/+$/,"/");
    return host + path;
  }catch(e){
    return raw.toLowerCase()
      .replace(/^https?:\/\//,"")
      .replace(/^www\./,"")
      .replace(/\/+$/,"/");
  }
}

/* ---- Blogs ---- */
function renderBlogTabs(){
  const box=document.getElementById("blogTabs");
  box.innerHTML="";
  if(!bloggerBlogs.length){
    box.innerHTML = `<div class="small">ë¸”ë¡œê·¸ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. â€œë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°â€ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;
    return;
  }
  bloggerBlogs.slice(0,10).forEach((b,idx)=>{
    const el=document.createElement("div");
    el.className="tab"+(activeBlog && activeBlog.id===b.id ? " active":"");
    el.onclick=()=>{ activeBlog=b; localStorage.setItem("baseone_active_blog_id", b.id); loadBlogSelect(); renderBlogTabs(); updateStatusLine(); log(`í˜„ì¬ ë¸”ë¡œê·¸ ë³€ê²½: ${b.name||b.url||b.id}`, "good"); };
    el.innerHTML = `<b>ğŸŸ¦ ${idx+1}</b><small>${esc(b.name||"")} Â· ${esc(b.url||"")}</small>`;
    box.appendChild(el);
  });
}
function loadBlogSelect(){
  const sel=document.getElementById("blogSelect");
  sel.innerHTML="";
  if(!bloggerBlogs.length){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="(ë¸”ë¡œê·¸ ì—†ìŒ) ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ë¨¼ì €";
    sel.appendChild(opt);
    document.getElementById("activeBlogText").textContent="-";
    return;
  }
  bloggerBlogs.forEach(b=>{
    const opt=document.createElement("option");
    opt.value=JSON.stringify(b);
    opt.textContent=`${b.name} (${b.url})`;
    sel.appendChild(opt);
  });

  if(!activeBlog){
    const savedId=localStorage.getItem("baseone_active_blog_id");
    activeBlog = bloggerBlogs.find(x=>x.id===savedId) || bloggerBlogs[0];
  }
  document.getElementById("activeBlogText").textContent = activeBlog ? (activeBlog.name||activeBlog.url||activeBlog.id) : "-";
  for(let i=0;i<sel.options.length;i++){
    try{
      const b=JSON.parse(sel.options[i].value);
      if(activeBlog && b.id===activeBlog.id){ sel.selectedIndex=i; break; }
    }catch(e){}
  }
}
function setActiveFromSelect(){
  const v=document.getElementById("blogSelect").value;
  if(!v){ alert("ì„ íƒí•  ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  activeBlog=JSON.parse(v);
  localStorage.setItem("baseone_active_blog_id", activeBlog.id);
  renderBlogTabs(); loadBlogSelect(); updateStatusLine();
  log(`í˜„ì¬ ë¸”ë¡œê·¸ ì„ íƒë¨: ${activeBlog.name||activeBlog.url||activeBlog.id}`, "good");
}
async function loadBlogs(){
  try{
    setBusy(true);
    log("ë¸”ë¡œê·¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "dim");

    const res=await fetch(apiBase()+"/api/blogger/blogs");
    const j=await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok){
      log("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: OAuth ì—°ê²°ì„ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”.", "bad");
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ë¨¼ì € OAuth ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }

    const d=settings();
    const allowRaw=(d.blogspot_urls||[]).map(x=>String(x||"").trim()).filter(Boolean);
    const allow = allowRaw.map(normUrl).filter(Boolean);

    bloggerBlogs = (j.items||[]);
    if(allow.length){
      bloggerBlogs = bloggerBlogs.filter(b => allow.includes(normUrl(b.url)));
    }

    if(!bloggerBlogs.length){
      log("ë¶ˆëŸ¬ì˜¨ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. (ì„¤ì • ì œí•œì´ ê±¸ë ¸ê±°ë‚˜ URLì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)", "bad");
      alert("ë¶ˆëŸ¬ì˜¨ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.\n(ì„¤ì •ì˜ blogspot_urls ì œí•œì´ ê±¸ë ¸ê±°ë‚˜ URLì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)\n\níŒ: ì œí•œì„ ë¹„ìš°ë©´ ì „ì²´ ë¸”ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.");
      loadBlogSelect(); renderBlogTabs(); updateStatusLine();
      return;
    }

    if(!activeBlog){
      activeBlog = bloggerBlogs[0];
      localStorage.setItem("baseone_active_blog_id", activeBlog.id);
    }

    loadBlogSelect(); renderBlogTabs(); updateStatusLine();
    log(`ë¸”ë¡œê·¸ ${bloggerBlogs.length}ê°œ ë¡œë“œ ì™„ë£Œ`, "good");
  }catch(e){
    log("ì„œë²„ ì—°ê²° ì‹¤íŒ¨(ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°)", "bad");
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }finally{
    setBusy(false);
  }
}

/* ---- Topics ---- */
function makeLocalTopics(){
  const hooks=["ì´ˆë³´ë„ ë°”ë¡œ ë˜ëŠ”","ëˆ ìƒˆëŠ” êµ¬ë© ë§‰ëŠ”","ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©","í—·ê°ˆë¦¬ê¸° ì‰¬ìš´","ì •ë¦¬ í•œ ë²ˆì—","ì‹¤ìˆ˜ ì¤„ì´ëŠ”"];
  const bases=["í™˜ê¸‰ë°›ëŠ” ë°©ë²• ì´ì •ë¦¬","ê³ ì •ë¹„ ì¤„ì´ëŠ” ìˆœì„œ","ë†“ì¹˜ë©´ ì†í•´ ë³´ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸","ì‹ ì²­ ì¡°ê±´/ëŒ€ìƒ ì •ë¦¬","ì ˆì„¸ í¬ì¸íŠ¸","ì‹¤ìˆ˜ TOP 7","ë¹„êµ ê¸°ì¤€","í•œ ë‹¬ì— ì•„ë¼ëŠ” ë°©ë²•"];
  const out=new Set();
  while(out.size<24){
    const h=hooks[Math.floor(Math.random()*hooks.length)];
    const b=bases[Math.floor(Math.random()*bases.length)];
    out.add(`${h} ${selectedCat} ${b}`);
  }
  topics=[...out].map((t,i)=>({id:`L_${Date.now()}_${i}`, title:t, checked:(i<10), html:"", image_url:"", image_prompt:""}));
  selectedTopicId=topics[0]?.id||"";
  renderTopics(); updateStatusLine();
  log("ë¡œì»¬ ì£¼ì œ ìƒì„± ì™„ë£Œ", "good");
}
async function makeMoneyTopics(){
  const d=settings();
  if(!d.gemini_key && !d.openai_key){
    alert("ì„¤ì •ì—ì„œ GEMINI ë˜ëŠ” OPENAI í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.");
    return;
  }
  const count = Math.max(5, Math.min(60, Number(document.getElementById("topicCount").value||30)));
  try{
    setBusy(true);
    log(`AI ì£¼ì œ ìƒì„± ìš”ì²­... (${count}ê°œ)`, "dim");

    const res=await fetch(apiBase()+"/api/topics/money",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        count,
        category:selectedCat,
        writer:d.writer||"gemini",
        gemini_key:d.gemini_key||"",
        gemini_model:d.gemini_model||"gemini-1.5-flash",
        openai_key:d.openai_key||"",
        openai_model:d.openai_model||"gpt-5.2-mini"
      })
    });

    const j=await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok){
      log("AI ì£¼ì œ ìƒì„± ì‹¤íŒ¨(ì„œë²„ì— /api/topics/money ê°€ ì—†ì„ ìˆ˜ë„ ìˆì–´ìš”)", "bad");
      alert("ì£¼ì œ ìƒì„± ì‹¤íŒ¨: " + (j.error || "ì„œë²„ì— /api/topics/moneyê°€ ì—†ì„ ìˆ˜ ìˆìŒ"));
      return;
    }

    topics=(j.items||[]).slice(0,count).map((t,i)=>({id:`G_${Date.now()}_${i}`, title:String(t), checked:(i<10), html:"", image_url:"", image_prompt:""}));
    selectedTopicId=topics[0]?.id||"";
    renderTopics(); updateStatusLine();
    log("AI ì£¼ì œ ìƒì„± ì™„ë£Œ", "good");
  }catch(e){
    log("ì„œë²„ ì—°ê²° ì‹¤íŒ¨(AI ì£¼ì œ)", "bad");
    alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
  }finally{
    setBusy(false);
  }
}

function toggleChecked(id){
  const t=topics.find(x=>x.id===id);
  if(!t) return;
  t.checked=!t.checked;
  renderTopics();
  updateStatusLine();
}

function setSelected(id){
  selectedTopicId=id;
  renderTopics();
  updateStatusLine();
  const t=getSelectedTopic();
  if(t){
    log(`ì„ íƒë¨: ${t.title}`, "dim");
    if(t.html) applyPreview(t);
  }
}
function getSelectedTopic(){ return topics.find(x=>x.id===selectedTopicId) || null; }

function renderTopics(){
  const q=(document.getElementById("filter").value||"").trim().toLowerCase();
  const box=document.getElementById("topicList");
  box.innerHTML="";
  let arr=topics.slice();
  if(q) arr=arr.filter(x=>x.title.toLowerCase().includes(q));
  if(!arr.length){
    box.innerHTML=`<div class="small">ì£¼ì œ ì—†ìŒ</div>`;
    return;
  }

  arr.forEach(it=>{
    const d=document.createElement("div");
    const isSel = it.id===selectedTopicId;
    const cls = ["item"];
    if(it.checked) cls.push("checked");
    if(isSel) cls.push("selected");
    d.className = cls.join(" ");
    d.onclick=()=>setSelected(it.id);

    d.innerHTML=`
      <div style="flex:1">
        <div class="itemTitle">
          <input type="checkbox" ${it.checked?"checked":""}
            onclick="event.stopPropagation(); toggleChecked('${it.id}')"
            style="transform:translateY(1px);margin-right:8px"/>
          ${esc(it.title)}
        </div>
        <div class="itemMeta">ğŸ·ï¸ ${esc(selectedCat)} Â· ${it.html ? "âœ… ìƒì„±ë¨":"â³ ë¯¸ìƒì„±"}</div>
      </div>
      <div class="rightBtns" onclick="event.stopPropagation()">
        <button class="btn good" onclick="setSelected('${it.id}')">ğŸ¯ ì„ íƒ</button>
        <button class="btn" onclick="navigator.clipboard.writeText('${it.title.replaceAll("'","\\'")}'); log('ì œëª© ë³µì‚¬ ì™„ë£Œ', 'good');">ë³µì‚¬</button>
      </div>
    `;
    box.appendChild(d);
  });
}

/* ---- Link buttons (auto insert into article HTML) ---- */
function buildLinkButtonsHtml(topic, sites){
  const safeSites = (sites||[])
    .map(u=>String(u||"").trim())
    .filter(Boolean)
    .slice(0, 12);

  const q = encodeURIComponent(topic);
  const google = `https://www.google.com/search?q=${q}`;
  const naver  = `https://search.naver.com/search.naver?query=${q}`;

  const btns = [];
  safeSites.forEach((u,i)=>{
    btns.push(`<a style="display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.10);background:#fff;text-decoration:none;color:#111;font-weight:800" href="${escAttr(u)}" target="_blank" rel="noopener">ğŸ”— ë‚´ ì‚¬ì´íŠ¸ ${i+1}</a>`);
  });
  btns.push(`<a style="display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.10);background:#fff;text-decoration:none;color:#111;font-weight:800" href="${google}" target="_blank" rel="noopener">ğŸ” êµ¬ê¸€ ê²€ìƒ‰</a>`);
  btns.push(`<a style="display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.10);background:#fff;text-decoration:none;color:#111;font-weight:800" href="${naver}" target="_blank" rel="noopener">ğŸŸ¢ ë„¤ì´ë²„ ê²€ìƒ‰</a>`);

  return `<div style="display:flex;flex-wrap:wrap;gap:8px;margin:14px 0;padding:12px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:rgba(240,240,240,.85)">
    <b style="margin-right:6px;color:#111">ğŸ“Œ ì°¸ê³ /ê´€ë ¨ ë§í¬</b>
    ${btns.join("")}
  </div>`;
}

/* ---- Generate ---- */
async function generateOne(topicObj){
  const d=settings();
  if(!d.gemini_key && !d.openai_key){
    alert("ì„¤ì •ì—ì„œ GEMINI ë˜ëŠ” OPENAI í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.");
    return false;
  }

  const payload={
    topic: topicObj.title,
    category: selectedCat,
    writer: d.writer || "gemini",
    gemini_key: d.gemini_key || "",
    gemini_model: d.gemini_model || "gemini-1.5-flash",
    openai_key: d.openai_key || "",
    openai_model: d.openai_model || "gpt-5.2-mini",
    img_provider: d.img_provider || "pexels",
    pexels_key: d.pexels_key || ""
  };

  const res=await fetch(apiBase()+"/api/generate",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const j=await res.json().catch(()=> ({}));
  if(!res.ok || !j.ok){
    throw new Error(j.error || "generate failed");
  }

  // âœ… ë‚´ ì‚¬ì´íŠ¸ ë§í¬ ë²„íŠ¼ ì„¹ì…˜ì„ ê¸€ í•˜ë‹¨ì— ì¶”ê°€
 topicObj.html = (j.html || "");


  topicObj.html = (j.html || "") + linkHtml;
  topicObj.image_url = j.image_url || "";
  topicObj.image_prompt = j.image_prompt || "";
  return true;
}

async function generateSelected(){
  const t=getSelectedTopic();
  if(!t){ alert("ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
  try{
    setBusy(true);
    log(`ì„ íƒ ê¸€ ìƒì„± ì‹œì‘: ${t.title}`, "dim");
    await generateOne(t);
    log("ì„ íƒ ê¸€ ìƒì„± ì™„ë£Œ", "good");
    applyPreview(t);
    renderTopics(); updateStatusLine();
  }catch(e){
    log("ìƒì„± ì‹¤íŒ¨: " + e.message, "bad");
    alert("ìƒì„± ì‹¤íŒ¨: " + e.message);
  }finally{
    setBusy(false);
  }
}

async function generateChecked(){
  const list = topics.filter(x=>x.checked);
  if(!list.length){ alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const targets = list.filter(x=>!x.html);
  if(!targets.length){ alert("ì²´í¬ëœ ê¸€ì€ ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤."); return; }

  try{
    setBusy(true);
    log(`ì²´í¬ ê¸€ ëŒ€ëŸ‰ ìƒì„± ì‹œì‘: ${targets.length}ê°œ`, "dim");
    for(let i=0;i<targets.length;i++){
      log(`ìƒì„±ì¤‘ ${i+1}/${targets.length}: ${targets[i].title}`, "dim");
      await generateOne(targets[i]);
    }
    log("ì²´í¬ ê¸€ ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ", "good");
    renderTopics(); updateStatusLine();
    const sel=getSelectedTopic(); if(sel && sel.html) applyPreview(sel);
  }catch(e){
    log("ëŒ€ëŸ‰ ìƒì„± ì‹¤íŒ¨: " + e.message, "bad");
    alert("ëŒ€ëŸ‰ ìƒì„± ì‹¤íŒ¨: " + e.message);
  }finally{
    setBusy(false);
  }
}

/* ---- Preview ---- */
function applyPreview(t){
  document.getElementById("previewMeta").textContent = `ğŸ§  ${t.title} / ğŸ·ï¸ ${selectedCat}`;
  document.getElementById("finalBody").textContent = t.html || "(ë¹„ì–´ìˆìŒ)";
  document.getElementById("finalImage").textContent = t.image_url ? `${t.image_prompt||""}\n${t.image_url}` : (t.image_prompt||"(ë¹„ì–´ìˆìŒ)");

  document.getElementById("previewIframe").srcdoc =
    `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:16px;line-height:1.7}</style>
    </head><body>${t.html || ""}</body></html>`;

  const img=document.getElementById("previewImg");
  const hint=document.getElementById("imgHint");
  if(t.image_url){
    img.src=t.image_url; img.style.display="block"; hint.style.display="none";
  }else{
    img.style.display="none"; hint.style.display="block";
  }
}

function copyHtml(){
  const t=getSelectedTopic();
  if(!t || !t.html){ alert("ë³µì‚¬í•  HTMLì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸€ì„ ìƒì„±í•˜ì„¸ìš”."); return; }
  navigator.clipboard.writeText(t.html);
  log("HTML ë³µì‚¬ ì™„ë£Œ", "good");
}

/* ---- Publish ---- */
async function publishSelected(){
  const t=getSelectedTopic();
  if(!t){ alert("ì„ íƒëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  if(!t.html){ alert("ë¨¼ì € ê¸€ì„ ìƒì„±í•˜ì„¸ìš”."); return; }
  if(!activeBlog || !activeBlog.id){ alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„, ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }

  try{
    setBusy(true);
    log("ë°œí–‰ ìš”ì²­ ì¤‘...", "dim");
    const res = await fetch(apiBase()+"/api/blogger/post",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({blog_id: activeBlog.id, title: t.title, html: t.html})
    });
    const j = await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok){
      throw new Error(j.error || "publish failed");
    }
    log("ë°œí–‰ ì™„ë£Œ âœ…", "good");
    if(j.url) log("URL: " + j.url, "good");
    alert("ë°œí–‰ ì™„ë£Œ!\n" + (j.url || ""));
  }catch(e){
    log("ë°œí–‰ ì‹¤íŒ¨: " + e.message, "bad");
    alert("ë°œí–‰ ì‹¤íŒ¨: " + e.message);
  }finally{
    setBusy(false);
  }
}

/* ---- Schedule ---- */
async function scheduleChecked(){
  const list = topics.filter(x=>x.checked);
  if(!list.length){ alert("ì²´í¬ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  if(!activeBlog || !activeBlog.id){ alert("ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° í›„, ë¸”ë¡œê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }

  const startVal = (document.getElementById("scheduleAt").value||"").trim();
  if(!startVal){ alert("ì˜ˆì•½ ì‹œì‘ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  const gapMin = Math.max(5, Number(document.getElementById("gapMin").value||120));

  try{
    setBusy(true);
    log(`ì˜ˆì•½ ì €ì¥ ì‹œì‘: ${list.length}ê°œ / gap=${gapMin}ë¶„`, "dim");

    // ìƒì„± ì•ˆëœ ê¸€ì€ ë¨¼ì € ìƒì„±
    const needGen = list.filter(x=>!x.html);
    if(needGen.length){
      log(`ì˜ˆì•½ ì „ ë¯¸ìƒì„± ê¸€ ${needGen.length}ê°œ ìƒì„± ì‹œì‘`, "dim");
      for(let i=0;i<needGen.length;i++){
        log(`ìƒì„±ì¤‘ ${i+1}/${needGen.length}: ${needGen[i].title}`, "dim");
        await generateOne(needGen[i]);
      }
      log("ì˜ˆì•½ ì „ ìƒì„± ì™„ë£Œ", "good");
      renderTopics(); updateStatusLine();
    }

    const start = new Date(startVal);
    for(let i=0;i<list.length;i++){
      const t=list[i];
      const run = new Date(start.getTime() + i*gapMin*60*1000);
      const res = await fetch(apiBase()+"/api/tasks/add",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          platform:"blogspot",
          blog_id:activeBlog.id,
          blog_url:activeBlog.url||"",
          title:t.title,
          html:t.html,
          run_at:run.toISOString()
        })
      });
      const j = await res.json().catch(()=> ({}));
      if(!res.ok || !j.ok){
        throw new Error(j.error || "task add failed");
      }
      log(`ì˜ˆì•½ ì €ì¥ë¨: ${t.title}`, "good");
    }

    log("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ âœ…", "good");
    refreshTasks();
    alert("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ!");
  }catch(e){
    log("ì˜ˆì•½ ì‹¤íŒ¨: " + e.message, "bad");
    alert("ì˜ˆì•½ ì‹¤íŒ¨: " + e.message);
  }finally{
    setBusy(false);
  }
}

/* ---- Tasks UI ---- */
async function refreshTasks(){
  const box=document.getElementById("taskList");
  box.textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    const res=await fetch(apiBase()+"/api/tasks/list");
    const j=await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok){ box.textContent="ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"; return; }
    const items=j.items||[];
    if(!items.length){ box.textContent="ì˜ˆì•½ ì—†ìŒ"; return; }

    box.innerHTML = items.slice(0,80).map(it=>{
      const st=it.status;
      const badge = st==="ok"?"âœ…":st==="err"?"âŒ":st==="running"?"ğŸŸ¦":st==="canceled"?"ğŸš«":"â³";
      const url = it.result_url ? `<div><a href="${escAttr(it.result_url)}" target="_blank">ğŸ”— ê²°ê³¼ ë§í¬</a></div>` : "";
      const err = it.error ? `<div style="color:#ffb4b4">ì—ëŸ¬: ${esc(it.error)}</div>` : "";
      const cancelBtn = (st==="pending") ? `<button class="btn danger" onclick="cancelTask(${it.id})">ì·¨ì†Œ</button>` : "";
      return `
        <div style="padding:10px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.06);margin-top:8px">
          <div style="font-weight:900">${badge} [#${it.id}] ${esc(it.title)}</div>
          <div class="small">blog_id: ${esc(it.blog_id||"-")} / run_at(UTC): ${esc(it.run_at)}</div>
          ${url}
          ${err}
          <div style="margin-top:6px">${cancelBtn}</div>
        </div>
      `;
    }).join("");
  }catch(e){
    box.textContent="ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
  }
}
async function cancelTask(id){
  if(!confirm("ì´ ì˜ˆì•½ì„ ì·¨ì†Œí• ê¹Œìš”?")) return;
  await fetch(apiBase()+`/api/tasks/cancel/${id}`, {method:"POST"});
  refreshTasks();
}

/* ---- Keyword -> Topics ---- */
async function keywordToTopics(){
  const seed = (document.getElementById("kwSeed").value||"").trim();
  const count = Math.max(5, Math.min(60, Number(document.getElementById("kwCount").value||30)));
  if(!seed){ alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ì •ë¶€ì§€ì›ê¸ˆ, ì¹´ë“œ ì¶”ì²œ"); return; }

  const d = settings();
  if(!d.gemini_key && !d.openai_key){
    alert("ì„¤ì •ì—ì„œ GEMINI ë˜ëŠ” OPENAI í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.");
    return;
  }

  try{
    setBusy(true);
    log(`í‚¤ì›Œë“œâ†’ì£¼ì œ ìƒì„± ìš”ì²­: "${seed}" (${count}ê°œ)`, "dim");

    const res = await fetch(apiBase()+"/api/keywords/collect_topics",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        seed,
        category: selectedCat,
        count,
        writer: d.writer || "gemini",
        gemini_key: d.gemini_key || "",
        gemini_model: d.gemini_model || "gemini-1.5-flash",
        openai_key: d.openai_key || "",
        openai_model: d.openai_model || "gpt-5.2-mini"
      })
    });

    const j = await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok){
      throw new Error(j.error || "ì„œë²„ì— /api/keywords/collect_topics ê°€ ì—†ì„ ìˆ˜ ìˆìŒ");
    }

    const items = (j.topics || []).slice(0, count);
    topics = items.map((t,i)=>({
      id: `K_${Date.now()}_${i}`,
      title: String(t),
      checked: (i < 10),
      html:"",
      image_url:"",
      image_prompt:""
    }));
    selectedTopicId = topics[0]?.id || "";
    renderTopics(); updateStatusLine();
    log(`ì£¼ì œ ${items.length}ê°œ ìƒì„± ì™„ë£Œ`, "good");
  }catch(e){
    log("í‚¤ì›Œë“œâ†’ì£¼ì œ ì‹¤íŒ¨: " + e.message, "bad");
    alert("í‚¤ì›Œë“œâ†’ì£¼ì œ ì‹¤íŒ¨: " + e.message);
  }finally{
    setBusy(false);
  }
}

/* ---- init ---- */
(function init(){
  document.getElementById("logBox").textContent = "";
  log("ì¤€ë¹„ ì™„ë£Œ. â‘ OAuth â‘¡ë‚´ ë¸”ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° â‘¢ì£¼ì œ ìƒì„± ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”.", "dim");

  refreshOAuth();
  setInterval(refreshOAuth, 6000);

  makeLocalTopics();
  loadBlogSelect();
  renderTopics();
  updateStatusLine();
})();
</script>

</body>
</html>

