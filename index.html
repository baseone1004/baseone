<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>BaseOne</title>
  <style>
    body { font-family: sans-serif; text-align: center; background:#f7f7f7; margin:0; }
    h1 { margin:26px 0 8px; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 0 16px 40px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; max-width: 820px; margin: 18px auto; }
    button { padding: 12px; font-size: 14px; border: none; border-radius: 10px; cursor: pointer; background: #4f8fe7; color: white; }
    button:hover { background:#2f6fd0; }
    .blogrow { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .blogbtn { background:#666; padding:10px 16px; border-radius:999px; }
    .active { background:#28a745 !important; }
    .hint { font-size:13px; color:#555; margin: 10px 0 0; }
    .bar { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 18px 0; }
    .primary { background:#111a2e; }
    .primary:hover { background:#0b1220; }

    #result, #topicsBox, #jobBox {
      max-width: 820px;
      margin: 18px auto;
      text-align:left;
      font-size:14px;
      background:#fff;
      border-radius:14px;
      padding: 14px 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    .small { font-size:12px; color:#777; }
    ol { padding-left: 20px; }
    .topic-row { display:flex; gap:10px; align-items:flex-start; margin:8px 0; }
    .topic-row input { margin-top:3px; }
    .topic-title { line-height:1.4; }

    .statusline { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eef2ff; color:#233c9f; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BaseOne</h1>
    <div class="hint">주제 선택 → 블로그 선택 → <b>주제 50개 만들기</b> → 체크 → <b>대량 글 생성</b></div>

    <!-- 주제 선택 -->
    <div class="grid" id="catGrid">
      <button onclick="selectCategory(this,'건강')">건강</button>
      <button onclick="selectCategory(this,'컴퓨터/IT')">컴퓨터/IT</button>
      <button onclick="selectCategory(this,'자동차')">자동차</button>
      <button onclick="selectCategory(this,'생활/가전')">생활/가전</button>
      <button onclick="selectCategory(this,'육아')">육아</button>
      <button onclick="selectCategory(this,'돈/재테크')">돈/재테크</button>
      <button onclick="selectCategory(this,'여행')">여행</button>
      <button onclick="selectCategory(this,'요리')">요리</button>
      <button onclick="selectCategory(this,'자기계발')">자기계발</button>
      <button onclick="selectCategory(this,'공부/자격증')">공부/자격증</button>
      <button onclick="selectCategory(this,'반려동물')">반려동물</button>
      <button onclick="selectCategory(this,'패션/뷰티')">패션/뷰티</button>
      <button onclick="selectCategory(this,'취미')">취미</button>
      <button onclick="selectCategory(this,'스포츠')">스포츠</button>
      <button onclick="selectCategory(this,'게임')">게임</button>
      <button onclick="selectCategory(this,'영화/드라마')">영화/드라마</button>
    </div>

    <!-- 블로그 선택 -->
    <div class="blogrow" id="blogRow">
      <button class="blogbtn" onclick="selectBlog(this,'블로그스팟')">블로그스팟</button>
      <button class="blogbtn" onclick="selectBlog(this,'네이버')">네이버</button>
      <button class="blogbtn" onclick="selectBlog(this,'티스토리')">티스토리</button>
    </div>

    <div class="bar">
      <button class="primary" onclick="generateTopics()">주제 50개 만들기</button>
      <button onclick="selectAll(true)">전체 선택</button>
      <button onclick="selectAll(false)">전체 해제</button>
      <button class="primary" onclick="bulkGenerate()">대량 글 생성(최대 10개)</button>
    </div>

    <div id="result">
      <div class="small">아직 생성 전입니다. 주제/블로그 선택 후 “주제 50개 만들기”를 눌러주세요.</div>
    </div>

    <div id="topicsBox" style="display:none;"></div>
    <div id="jobBox" style="display:none;"></div>
  </div>

<script>
  let selectedCategory = "";
  let selectedBlog = "";
  let currentTopics = []; // 50개 목록

  function clearActive(containerId, selector) {
    document.querySelectorAll(containerId + " " + selector).forEach(b => b.classList.remove("active"));
  }

  function selectCategory(btn, cat) {
    selectedCategory = cat;
    clearActive("#catGrid", "button");
    btn.classList.add("active");
  }

  function selectBlog(btn, blog) {
    selectedBlog = blog;
    clearActive("#blogRow", "button");
    btn.classList.add("active");
  }

  async function generateTopics() {
    const result = document.getElementById("result");
    const topicsBox = document.getElementById("topicsBox");
    const jobBox = document.getElementById("jobBox");
    jobBox.style.display = "none";

    if (!selectedCategory || !selectedBlog) {
      result.innerHTML = "<b>주제와 블로그를 모두 선택해야 합니다.</b>";
      return;
    }

    result.innerHTML = "Gemini가 주제를 만드는 중입니다... (잠시만요)";
    topicsBox.style.display = "none";

    try {
      const res = await fetch("/api/topics", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ category: selectedCategory, blog: selectedBlog })
      });
      const data = await res.json();

      if (!data.ok) {
        result.innerHTML = "<b>에러:</b> " + (data.error || "알 수 없는 오류");
        return;
      }

      currentTopics = data.topics || [];
      result.innerHTML = `<div class="statusline">
        <div><span class="pill">${selectedCategory}</span> <span class="pill">${selectedBlog}</span></div>
        <div class="small">원하는 주제를 체크하고 “대량 글 생성”을 누르세요. (처음은 10개 제한)</div>
      </div>`;

      let html = `<h3>주제 50개 (체크 선택)</h3>`;
      html += `<div class="small">※ 생성된 글/이미지는 BaseOne/output 폴더에 저장됩니다.</div>`;
      html += `<div style="margin-top:10px;">`;

      currentTopics.forEach((t, i) => {
        html += `
          <div class="topic-row">
            <input type="checkbox" class="topicCheck" data-idx="${i}">
            <div class="topic-title">${t}</div>
          </div>`;
      });

      html += `</div>`;
      topicsBox.innerHTML = html;
      topicsBox.style.display = "block";
    } catch (e) {
      result.innerHTML = "<b>연결 실패</b>: 서버가 켜져 있는지 확인하세요. (server.py 실행 중이어야 함)";
    }
  }

  function selectAll(on) {
    document.querySelectorAll(".topicCheck").forEach(ch => ch.checked = on);
  }

  function getSelectedTopics() {
    const selected = [];
    document.querySelectorAll(".topicCheck").forEach(ch => {
      if (ch.checked) {
        const idx = parseInt(ch.getAttribute("data-idx"), 10);
        if (!isNaN(idx) && currentTopics[idx]) selected.push(currentTopics[idx]);
      }
    });
    return selected;
  }

  async function bulkGenerate() {
    const jobBox = document.getElementById("jobBox");
    const selected = getSelectedTopics();

    if (!selectedCategory || !selectedBlog) {
      alert("주제/블로그를 먼저 선택하세요.");
      return;
    }
    if (selected.length === 0) {
      alert("최소 1개는 체크해야 해요.");
      return;
    }

    jobBox.style.display = "block";
    jobBox.innerHTML = "글/이미지 생성 시작... (잠시만요)";

    try {
      const res = await fetch("/api/start_generate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ category: selectedCategory, blog: selectedBlog, topics: selected })
      });
      const data = await res.json();
      if (!data.ok) {
        jobBox.innerHTML = "<b>에러:</b> " + (data.error || "알 수 없는 오류");
        return;
      }

      const jobId = data.job_id;
      await pollJob(jobId);
    } catch (e) {
      jobBox.innerHTML = "<b>실패</b>: 서버/네트워크를 확인하세요.";
    }
  }

  async function pollJob(jobId) {
    const jobBox = document.getElementById("jobBox");
    while (true) {
      const res = await fetch(`/api/job/${jobId}`);
      const data = await res.json();
      if (!data.ok) {
        jobBox.innerHTML = "<b>작업 조회 실패:</b> " + (data.error || "");
        return;
      }
      const job = data.job;
      const logs = (job.logs || []).slice(-10).map(x => `<div class="small">- ${x}</div>`).join("");
      jobBox.innerHTML = `
        <h3>대량 생성 진행</h3>
        <div class="small">상태: <b>${job.status}</b> · 진행: ${job.done}/${job.total}</div>
        <div style="margin-top:8px;">${logs}</div>
        <div class="small" style="margin-top:10px;">완료되면 BaseOne/output 폴더에 HTML이 저장돼요.</div>
      `;

      if (job.status === "done" || job.status === "error") {
        if (job.status === "done") {
          jobBox.innerHTML += `<div style="margin-top:12px;"><b>완료!</b> output 폴더를 열어 확인하세요.</div>`;
        }
        return;
      }
      await new Promise(r => setTimeout(r, 1200));
    }
  }
</script>

</body>
</html>
